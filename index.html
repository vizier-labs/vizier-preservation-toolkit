<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vizier Preservation Toolkit v1.0</title>
    
    <!-- Suppress Tailwind CDN warning -->
    <script>
        // Override console.warn temporarily to suppress Tailwind's production warning
        (function() {
            const originalWarn = console.warn;
            console.warn = function(...args) {
                const msg = args[0];
                if (typeof msg === 'string' && msg.includes('cdn.tailwindcss.com should not be used in production')) {
                    return; // Suppress this specific warning
                }
                originalWarn.apply(console, args);
            };
        })();
    </script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for better UX */
        .checkpoint-card {
            transition: all 0.2s ease;
        }
        .checkpoint-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .section-check {
            display: inline-block;
            margin-right: 0.5rem;
        }
        
        /* Watermark */
        .vizier-watermark {
            position: fixed;
            bottom: 16px;
            right: 16px;
            width: 140px;
            height: 140px;
            opacity: 0.10;
            pointer-events: none;
            z-index: 1;
        }
        
        /* Restoration button on cards */
        .btn-restore-card {
            font-size: 0.875rem;
            padding: 0.375rem 0.75rem;
            background-color: #10b981;
            color: white;
            border-radius: 0.375rem;
            transition: background-color 0.2s;
        }
        .btn-restore-card:hover {
            background-color: #059669;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    
    <!-- Header -->
    <header class="bg-indigo-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <h1 class="text-3xl font-bold">Vizier Preservation Toolkit <span class="text-lg text-indigo-200">v1.0</span></h1>
            <p class="text-indigo-100 mt-1">State Ledger, Work Logs & Artifact Registry for AI Projects</p>
            
            <!-- Global Actions Bar -->
            <div class="flex items-center justify-between mt-4 pb-4 border-b border-indigo-500">
                <div class="flex gap-3">
<button onclick="showProjectManagerModal()" class="bg-indigo-500 hover:bg-indigo-400 text-white px-4 py-2 rounded-lg transition font-medium">Projects</button>
                <button onclick="showExportModal()" 
                        class="bg-indigo-500 hover:bg-indigo-400 text-white px-4 py-2 rounded-lg transition font-medium text-sm">
                    üì§ Export
                </button>
                <button onclick="showImportModal()" 
                        class="bg-indigo-500 hover:bg-indigo-400 text-white px-4 py-2 rounded-lg transition font-medium text-sm">
                    üì• Import
                </button>
                <button onclick="showClearAllDataModal()" 
                        class="bg-red-500 hover:bg-red-400 text-white px-4 py-2 rounded-lg transition font-medium text-sm ml-auto">
                    üóëÔ∏è Clear All Data
                </button>
            </div>
            </div>
            
            <!-- Tab Navigation with Info Button -->
            <div class="flex justify-between items-center mt-4 border-b border-indigo-500">
                <div class="flex gap-4">
                    <button onclick="switchTab('checkpoints')" 
                            id="tabCheckpoints"
                            class="tab-button pb-2 px-4 border-b-2 border-white font-semibold">
                        State Ledger
                    </button>
                    <button onclick="switchTab('worklogs')" 
                            id="tabWorklogs"
                            class="tab-button pb-2 px-4 border-b-2 border-transparent hover:border-indigo-300 transition">
                        Work Logs
                    </button>
                    <button onclick="switchTab('artifacts')" 
                            id="tabArtifacts"
                            class="tab-button pb-2 px-4 border-b-2 border-transparent hover:border-indigo-300 transition">
                        Artifact Registry
                    </button>
                </div>
                <button onclick="showAboutModal()" 
                        class="text-indigo-100 hover:text-white transition pb-2"
                        title="About Vizier Systems">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                        <circle cx="10" cy="10" r="9" stroke="currentColor" stroke-width="1.5" fill="none"/>
                        <text x="10" y="14" text-anchor="middle" font-size="12" font-family="Georgia, serif" font-style="italic" fill="currentColor">i</text>
                    </svg>
                </button>
                </div>
                <button id="projectContextIndicator" type="button" onclick="showProjectManagerModal();" class="text-indigo-100 text-sm font-medium px-3 py-2 rounded-lg bg-indigo-800/40 border border-indigo-700/30 hover:bg-indigo-800/60 transition cursor-pointer">Project: All Projects</button>
            </div>>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container mx-auto px-4 py-8">
        
        <!-- CHECKPOINTS TAB -->
        <div id="checkpointsTab" class="tab-content">
            <!-- Action Bar -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex flex-wrap gap-4 items-center justify-between">
                <div class="flex gap-4">
                    <button onclick="showPromptGeneratorModal()" 
                            class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition font-semibold">
                        ‚ö° Generate Checkpoint Request
                    </button>
                    <button onclick="showSaveCheckpointModal()" 
                            class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition">
                        + Save Checkpoint
                    </button>
                </div>
            </div>

            <!-- Search Bar -->
            <div class="mt-4">
                <input type="text" 
                       id="searchInput"
                       placeholder="Search checkpoints..." 
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                       oninput="filterCheckpoints()">
            </div>

            <!-- Filters -->
            <div class="mt-4 flex gap-4 items-center">
                <label class="text-sm text-gray-600">Filter by project:</label>
                <select id="projectFilter" 
                        onchange="filterCheckpoints()"
                        class="px-3 py-1 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    <option value="">All Projects</option>
                </select>
                
                <label class="text-sm text-gray-600 ml-4">Sort by:</label>
                <select id="sortOrder" 
                        onchange="filterCheckpoints()"
                        class="px-3 py-1 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    <option value="newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                    <option value="project">By Project</option>
                </select>
            </div>
        </div>

        <!-- Checkpoints List -->
        <div id="checkpointsList" class="space-y-4">
            <!-- Checkpoints will be rendered here -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="text-center py-16 hidden">
            <div class="text-gray-400 text-6xl mb-4">üìã</div>
            <h3 class="text-xl font-semibold text-gray-700 mb-2">No Checkpoints Yet</h3>
            <p class="text-gray-600 mb-6">Checkpoints are restore points. Use them to preserve context, decisions, and next steps across sessions.</p>
            <button onclick="showProjectManagerModal()" class="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition">Create a Project</button>
        </div>

        </div>
        <!-- END CHECKPOINTS TAB -->

        <!-- WORK LOGS TAB -->
        <div id="worklogsTab" class="tab-content hidden">
            
            <!-- Action Bar -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex flex-wrap gap-4 items-center justify-between">
                    <div class="flex gap-4">
                        <button onclick="showWorkLogGeneratorModal()" 
                                class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition font-semibold">
                            ‚ö° Generate Work Log Template
                        </button>
                        <button onclick="showSaveWorkLogModal()" 
                                class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition">
                            + Save Work Log
                        </button>
                    </div>
                </div>

                <!-- Search Bar -->
                <div class="mt-4">
                    <input type="text" 
                           id="worklogSearchInput"
                           placeholder="Search work logs..." 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                           oninput="filterWorkLogs()">
                </div>

                <!-- Filters -->
                <div class="mt-4 flex gap-4 items-center flex-wrap">
                    <label class="text-sm text-gray-600">Filter by project:</label>
                    <select id="worklogProjectFilter" 
                            onchange="filterWorkLogs()"
                            class="px-3 py-1 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <option value="">All Projects</option>
                    </select>
                    
                    <label class="text-sm text-gray-600 ml-4">Sort by:</label>
                    <select id="worklogSortOrder" 
                            onchange="filterWorkLogs()"
                            class="px-3 py-1 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <option value="newest">Newest First</option>
                        <option value="oldest">Oldest First</option>
                        <option value="project">By Project</option>
                    </select>
                </div>

                <!-- Active Filter Indicator -->
                <div id="activeCheckpointFilterIndicator" class="mt-4 hidden">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <span class="text-blue-800 font-medium">üîç Filtered by checkpoint</span>
                            <span id="activeCheckpointFilterLabel" class="text-blue-600 text-sm"></span>
                        </div>
                        <button onclick="clearCheckpointFilter()" 
                                class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                            Clear Filter ‚úï
                        </button>
                    </div>
                </div>
            </div>

            <!-- Work Logs List -->
            <div id="worklogsList" class="space-y-4">
                <!-- Work logs will be rendered here -->
            </div>

            <!-- Empty State -->
            <div id="worklogsEmptyState" class="text-center py-16 hidden">
                <div class="text-gray-400 text-6xl mb-4">üìù</div>
                <h3 class="text-xl font-semibold text-gray-700 mb-2">No Work Logs Yet</h3>
                <p class="text-gray-600 mb-6">Work logs record what you completed and decided, without creating a restore point.</p>
                <button onclick="showWorkLogGeneratorModal()" 
                        class="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition">
                    Create a Work Log Your First Work Log
                </button>
            </div>

        </div>
        <!-- END WORK LOGS TAB -->

        <!-- ARTIFACTS TAB -->
        <div id="artifactsTab" class="tab-content hidden">
            
            <!-- Action Bar -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex flex-wrap gap-4 items-center justify-between">
                    <div class="flex gap-4">
                        <button onclick="showAddArtifactModal()" 
                                class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition">
                            + Add Artifact
                        </button>
                    </div>
                </div>

                <!-- Search Bar -->
                <div class="mt-4">
                    <input type="text" 
                           id="artifactSearchInput"
                           placeholder="Search artifacts..." 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                           oninput="filterArtifacts()">
                </div>

                <!-- Filters -->
                <div class="mt-4 flex gap-4 items-center">
                    <label class="text-sm text-gray-600">Filter by project:</label>
                    <select id="artifactProjectFilter" 
                            onchange="filterArtifacts()"
                            class="px-3 py-1 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <option value="">All Projects</option>
                    </select>
                    
                    <label class="text-sm text-gray-600 ml-4">Type:</label>
                    <select id="artifactTypeFilter" 
                            onchange="filterArtifacts()"
                            class="px-3 py-1 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <option value="">All Types</option>
                        <option value="document">Documents</option>
                        <option value="image">Images</option>
                        <option value="data">Data/CSV</option>
                        <option value="code">Code</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <!-- Active Filter Indicator -->
                <div id="activeArtifactCheckpointFilterIndicator" class="mt-4 hidden">
                    <div class="bg-purple-50 border border-purple-200 rounded-lg p-3 flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <span class="text-purple-800 font-medium">üîç Filtered by checkpoint</span>
                            <span id="activeArtifactCheckpointFilterLabel" class="text-purple-600 text-sm"></span>
                        </div>
                        <button onclick="clearArtifactCheckpointFilter()"
                                class="text-purple-600 hover:text-purple-800 text-sm font-medium">
                            Clear Filter ‚úï
                        </button>
                    </div>
                </div>
            </div>

            <!-- Artifacts List -->
            <div id="artifactsList" class="space-y-4">
                <!-- Artifacts will be rendered here -->
            </div>

            <!-- Empty State -->
            <div id="artifactsEmptyState" class="text-center py-16 hidden">
                <div class="text-gray-400 text-6xl mb-4">üìé</div>
                <h3 class="text-xl font-semibold text-gray-700 mb-2">No Artifacts Yet</h3>
                <p class="text-gray-600 mb-6">Artifacts track files, links, screenshots, and references tied to a project or checkpoint.</p>
                <button onclick="showAddArtifactModal()" 
                        class="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition">
                    Add an Artifact
                </button>
            </div>

        </div>
        <!-- END ARTIFACTS TAB -->

    </div>

    <!-- Modal: Add Artifact -->
    <div id="addArtifactModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <h2 class="text-2xl font-bold mb-4">Add Artifact</h2>
                <p class="text-gray-600 mb-6">Track files used in your AI projects</p>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Project</label>
                        <select id="artifactProject" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option value="">Select Project...</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Original Filename
                            <span class="text-gray-500 text-xs">(The file you're tracking)</span>
                        </label>
                        <input type="text" 
                               id="artifactOriginalName" 
                               placeholder="e.g., IMG_0473.png or document.pdf"
                               oninput="suggestArtifactName()"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Suggested Filename
                            <span class="text-gray-500 text-xs">(Clear, versioned name)</span>
                        </label>
                        <input type="text" 
                               id="artifactSuggestedName" 
                               placeholder="e.g., ProjectName_Floorplan_v2.png"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <p class="text-xs text-gray-500 mt-1">
                            Format: ProjectName_Description_v#.ext
                        </p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Description/Label
                        </label>
                        <input type="text" 
                               id="artifactLabel" 
                               placeholder="e.g., Kitchen floorplan final draft"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">File Type</label>
                        <select id="artifactType" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option value="document">Document (PDF, DOCX, TXT)</option>
                            <option value="image">Image (PNG, JPG, SVG)</option>
                            <option value="data">Data/Spreadsheet (CSV, XLSX)</option>
                            <option value="code">Code (PY, JS, HTML)</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            External Path (Optional)
                            <span class="text-gray-500 text-xs">(Where you keep this file)</span>
                        </label>
                        <input type="text" 
                               id="artifactPath" 
                               placeholder="e.g., /Users/me/Projects/Remodel/files/"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Link to Checkpoint (Optional)
                        </label>
                        <select id="artifactCheckpointLink" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option value="">Not linked to any checkpoint</option>
                        </select>
                    </div>

                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h3 class="font-semibold text-blue-900 mb-2">üí° Tip: File Management</h3>
                        <p class="text-sm text-blue-800">
                            This tool tracks <strong>metadata only</strong> - it doesn't store your actual files. 
                            Keep your files organized in a folder, and this tool helps you remember which files 
                            go with which checkpoints.
                        </p>
                    </div>
                </div>

                <div class="mt-6 flex gap-4 justify-end">
                    <button onclick="closeAddArtifactModal()" 
                            class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                        Cancel
                    </button>
                    <button onclick="saveArtifact()" 
                            class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                        Add Artifact
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Prompt Generator -->
    <div id="promptGeneratorModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <h2 class="text-2xl font-bold mb-4">Generate Checkpoint Request</h2>
                <p class="text-gray-600 mb-6">Generate the prompt to paste into your AI session</p>
                
                <div class="space-y-4">
                    <!-- Checkpoint Type Selection -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">Checkpoint Type</label>
                        <div class="space-y-2">
                            <label class="flex items-start p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-indigo-500 transition">
                                <input type="radio" name="checkpointType" value="master" checked 
                                       onchange="updatePromptPreview()"
                                       class="mt-1 mr-3">
                                <div>
                                    <div class="font-semibold text-gray-800">Master Checkpoint</div>
                                    <div class="text-sm text-gray-600">Full project state - use at major milestones</div>
                                </div>
                            </label>
                            
                            <label class="flex items-start p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-purple-500 transition">
                                <input type="radio" name="checkpointType" value="task" 
                                       onchange="updatePromptPreview()"
                                       class="mt-1 mr-3">
                                <div>
                                    <div class="font-semibold text-gray-800">Task-Specific Checkpoint</div>
                                    <div class="text-sm text-gray-600">Focused subtask - launches separate work session</div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Project Selection -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Project</label>
                        <select id="promptProjectSelect" 
                                onchange="updatePromptPreview()"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option value="">Select Project...</option>
                        </select>
                    </div>

                    <!-- Task Focus (for task-specific checkpoints) -->
                    <div id="taskFocusSection" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Task Focus
                            <span class="text-gray-500 text-xs">(What is this subtask focused on?)</span>
                        </label>
                        <input type="text" 
                               id="taskFocusInput" 
                               placeholder="e.g., revising the introduction section"
                               onchange="updatePromptPreview()"
                               oninput="updatePromptPreview()"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <p class="text-xs text-gray-500 mt-1">
                            Be specific: "drafting API documentation" not just "API work"
                        </p>
                    </div>

                    
                    <!-- Task List (Optional) -->
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Task List (Optional)
                            <span class="text-gray-500 text-xs ml-1">
                                One task per line for this checkpoint
                            </span>
                        </label>
                        <textarea id="taskListInput"
                                  rows="3"
                                  placeholder="- Draft toolkit v1.2 notes
- Update test guide
- Export project bundle"
                                  onchange="updatePromptPreview()"
                                  oninput="updatePromptPreview()"
                                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 font-mono text-sm"></textarea>
                        <p class="text-xs text-gray-500 mt-1">
                            These tasks will be folded into the generated checkpoint prompt so the AI knows what to focus on.
                        </p>
                    </div>
<!-- Generated Prompt Preview -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Generated Prompt
                            <span class="text-gray-500 text-xs">(Copy this and paste into AI chat)</span>
                        </label>
                        <div class="bg-gray-50 border-2 border-indigo-200 rounded-lg p-4">
                            <pre id="generatedPrompt" class="whitespace-pre-wrap font-mono text-sm text-gray-800"></pre>
                        </div>
                    </div>

                    <!-- Instructions -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h3 class="font-semibold text-blue-900 mb-2">üìã How to use:</h3>
                        <ol class="text-sm text-blue-800 space-y-1 list-decimal list-inside">
                            <li>Copy the generated prompt below</li>
                            <li>Open a <strong>new AI chat session</strong></li>
                            <li>Paste the prompt</li>
                            <li>AI will generate your checkpoint</li>
                            <li>Come back here and click "Save Checkpoint" to store it</li>
                        </ol>
                    </div>
                </div>

                <div class="mt-6 flex gap-4 justify-end">
                    <button onclick="closePromptGeneratorModal()" 
                            class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                        Cancel
                    </button>
                    <button onclick="copyGeneratedPrompt()" 
                            class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                        üìã Copy Prompt
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Save Checkpoint -->
    <div id="saveCheckpointModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <h2 class="text-2xl font-bold mb-4">Save Checkpoint</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Project</label>
                        <select id="checkpointProject" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option value="">Select Project...</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Checkpoint Content
                            <span class="text-gray-500 text-xs">(Paste from AI)</span>
                        </label>
                        <textarea id="checkpointContent" 
                                  rows="12"
                                  placeholder="Paste your checkpoint from AI here..."
                                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 font-mono text-sm"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Label (Optional)
                        </label>
                        <input type="text" 
                               id="checkpointLabel" 
                               placeholder="e.g., After contractor quotes"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>

                    <!-- Artifact Extraction Options -->
                    <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" 
                                   id="reviewArtifacts" 
                                   checked
                                   class="w-4 h-4 text-indigo-600 rounded focus:ring-2 focus:ring-indigo-500">
                            <span class="text-sm font-medium text-gray-700">
                                Review extracted artifacts before saving
                            </span>
                        </label>
                        <p class="text-xs text-gray-600 mt-1 ml-6">
                            Tool will extract files from "Files we used" section and let you approve them
                        </p>
                    </div>

                    <!-- Extracted Artifacts Preview -->
                    <div id="extractedArtifactsPreview" class="hidden">
                        <div class="bg-white border-2 border-indigo-200 rounded-lg p-4">
                            <h3 class="font-semibold text-sm mb-3 flex items-center gap-2">
                                <span>üìé</span>
                                <span>Extracted Artifacts</span>
                                <span id="artifactCount" class="text-xs text-gray-500"></span>
                            </h3>
                            <div id="extractedArtifactsList" class="space-y-2 max-h-48 overflow-y-auto">
                                <!-- Artifacts will be listed here -->
                            </div>
                            <p class="text-xs text-gray-500 mt-2">
                                ‚úì Check to include | ‚úó Uncheck to skip
                            </p>
                        </div>
                    </div>

                    <!-- Validation Display -->
                    <div id="validationResults" class="hidden">
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                            <h3 class="font-semibold text-sm mb-2">Validation Results:</h3>
                            <div id="validationDetails" class="text-sm space-y-1">
                                <!-- Validation results will appear here -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-6 flex gap-4 justify-end">
                    <button onclick="closeSaveCheckpointModal()" 
                            class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                        Cancel
                    </button>
                    <button onclick="previewExtractedArtifacts()" 
                            class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                        Preview Artifacts
                    </button>
                    <button onclick="validateCheckpoint()" 
                            class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                        Validate
                    </button>
                    <button onclick="saveCheckpoint()" 
                            class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                        Save Checkpoint
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: New Project -->
    <div id="newProjectModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="p-6">
                <h2 class="text-2xl font-bold mb-4">New Project</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Project Name</label>
                        <input type="text" 
                               id="newProjectName" 
                               placeholder="e.g., Home Remodel"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                </div>

                <div class="mt-6 flex gap-4 justify-end">
                    <button onclick="closeNewProjectModal()" 
                            class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                        Cancel
                    </button>
                    <button onclick="createProject()" 
                            class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                        Create Project
                    </button>
                </div>
            </div>
        </div>
    </div>

    
    <!-- Modal: Project Manager -->
    <div id="projectManagerModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 space-y-4">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-2xl font-bold">Projects</h2>
                    <button onclick="closeProjectManagerModal()" class="text-gray-500 hover:text-gray-700 text-xl">
                        ‚úï
                    </button>
                </div>

                <!-- Existing projects -->
                <div>
                    <h3 class="text-sm font-semibold text-gray-700 mb-2">Existing Projects</h3>
                    <div id="projectManagerList" class="space-y-2">
                        <!-- Filled by JS -->
                    </div>
                </div>

                <hr class="my-4">

                <!-- Create new project -->
                <div class="space-y-2">
                    <h3 class="text-sm font-semibold text-gray-700">Create New Project</h3>
                    <div class="flex gap-2">
                        <input type="text"
                               id="projectManagerNewProjectName"
                               placeholder="e.g., Vizier's Guide"
                               class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <button onclick="createProjectFromManager()"
                                class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                            Add
                        </button>
                    </div>
                    <p class="text-xs text-gray-500">
                        Projects are containers for checkpoints, work logs, and artifacts.
                    </p>
                </div>
            </div>
        </div>
    </div>


    <!-- Modal: About / Info -->
    <div id="aboutModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 space-y-4">
                <div class="flex justify-between items-start gap-4">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">Vizier Preservation Toolkit</h2>
                        <p class="text-sm text-gray-500 mt-1">Local, disciplined workflow support for multi-session AI projects.</p>
                    </div>
                    <button onclick="closeAboutModal()" class="text-gray-500 hover:text-gray-700 text-xl" title="Close">
                        ‚úï
                    </button>
                </div>

                <div class="space-y-4 text-sm text-gray-800 leading-relaxed">
                    <p>
                        This is a local, browser-based toolkit for managing AI-assisted projects using the Vizier method.
                        It is designed for disciplined, multi-session workflows where context, decisions, and progress must be preserved across conversations.
                    </p>

                    <div class="space-y-2">
                        <h3 class="text-base font-semibold text-gray-900">Core concepts</h3>
                        <ul class="list-disc pl-5 space-y-1">
                            <li><span class="font-semibold">Projects</span>: top-level containers. They hold checkpoints, work logs, and artifacts and are managed explicitly through the Projects menu.</li>
                            <li><span class="font-semibold">Checkpoints</span>: restore points you can paste into a new session.
                                <ul class="list-disc pl-5 mt-1 space-y-1">
                                    <li><span class="font-semibold">Master checkpoints</span> capture overall project state.</li>
                                    <li><span class="font-semibold">Task-specific checkpoints</span> launch focused subtasks with clear scope.</li>
                                </ul>
                            </li>
                            <li><span class="font-semibold">Work Logs</span>: lightweight records of completed work. They are not restore points. They exist to document progress and are designed to be copied into a master thread.</li>
                            <li><span class="font-semibold">Artifacts</span>: links, files, screenshots, and references associated with a project or checkpoint.</li>
                        </ul>
                    </div>

                    <div class="space-y-2">
                        <h3 class="text-base font-semibold text-gray-900">Prompt generation</h3>
                        <p>
                            The checkpoint generator helps structure restore and task-launch prompts. It does not automate thinking or guarantee results.
                            Prompt quality and outcomes remain the responsibility of the user.
                        </p>
                    </div>

                    <div class="space-y-2">
                        <h3 class="text-base font-semibold text-gray-900">Privacy model</h3>
                        <ul class="list-disc pl-5 space-y-1">
                            <li>All data is stored locally in your browser (localStorage).</li>
                            <li>No accounts, no server, no telemetry.</li>
                            <li>Export creates a portable JSON file for backup or transfer.</li>
                        </ul>
                    </div>

                    <div class="space-y-2">
                        <h3 class="text-base font-semibold text-gray-900">Recommended workflow</h3>
                        <ol class="list-decimal pl-5 space-y-1">
                            <li>Create a Project.</li>
                            <li>Capture a Master checkpoint when you need a restore point.</li>
                            <li>Use Task-specific checkpoints to launch focused work.</li>
                            <li>Record completed work using Work Logs.</li>
                            <li>Export regularly for backup or versioning.</li>
                        </ol>
                    </div>

                    <hr class="my-2">

                    <div class="space-y-2">
                        <div class="space-y-2 pt-2">
                        <h3 class="text-base font-semibold text-gray-900">Getting started</h3>
                        <ol class="list-decimal pl-5 space-y-1">
                            <li>Create a project.</li>
                            <li>Capture checkpoints when context matters.</li>
                            <li>Use work logs to record progress and decisions.</li>
                            <li>Export regularly as a backup.</li>
                        </ol>
                    </div>

                    <h3 class="text-base font-semibold text-gray-900">About Vizier Systems</h3>
                        <p>
                            Vizier Systems develops tools and methods for disciplined, multi-session AI workflows.
                            The Vizier Preservation Toolkit provides structured checkpoints, project-level organization, artifact tracking, and reliable session recovery,
                            with all data remaining local to your browser.
                        </p>
                        <div class="space-y-1">
                            <div class="font-semibold text-gray-900">Additional resources</div>
                            <ul class="list-disc pl-5 space-y-1">
                                <li>Substack: <a class="text-indigo-700 hover:underline" href="https://dunkerfosen.substack.com" target="_blank" rel="noopener noreferrer">dunkerfosen.substack.com</a></li>
                                <li>GitHub: <a class="text-indigo-700 hover:underline" href="https://github.com/VizierSystems" target="_blank" rel="noopener noreferrer">github.com/VizierSystems</a></li>
                            </ul>
                        </div>
                        <p class="text-xs text-gray-500">
                            No tracking, analytics, or external services are used.
                        </p>
                    </div>
                </div>

                <div class="flex justify-end pt-2">
                    <button onclick="closeAboutModal()"
                            class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

<!-- Modal: Import Data -->
    <div id="importModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="p-6">
                <h2 class="text-2xl font-bold mb-4">Import Data</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select JSON File</label>
                        <input type="file" 
                               id="importFile" 
                               accept=".json"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                        <p class="text-sm text-yellow-800">
                            ‚ö†Ô∏è Warning: This will merge with existing data. Export current data first if needed.
                        </p>
                    </div>
                </div>

                <div class="mt-6 flex gap-4 justify-end">
                    <button onclick="closeImportModal()" 
                            class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                        Cancel
                    </button>
                    <button onclick="importData()" 
                            class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                        Import
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Export Data -->
    <div id="exportModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <h2 class="text-2xl font-bold mb-4">Export Data</h2>
                <p class="text-gray-600 mb-6">Select which data to export</p>
                
                <div class="space-y-4">
                    <!-- Export All Option -->
                    <label class="flex items-start p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-indigo-500 transition">
                        <input type="radio" name="exportOption" value="all" checked 
                               onchange="updateExportPreview()"
                               class="mt-1 mr-3">
                        <div>
                            <div class="font-semibold text-gray-800">Export Everything</div>
                            <div class="text-sm text-gray-600">All projects, checkpoints, work logs, and artifacts</div>
                        </div>
                    </label>

                    <!-- Select Projects Option -->
                    <label class="flex items-start p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-indigo-500 transition">
                        <input type="radio" name="exportOption" value="selective" 
                               onchange="updateExportPreview()"
                               class="mt-1 mr-3">
                        <div class="flex-1">
                            <div class="font-semibold text-gray-800">Select Specific Projects</div>
                            <div class="text-sm text-gray-600 mb-2">Choose which projects to export</div>
                            
                            <!-- Project checkboxes (shown when selective is selected) -->
                            <div id="projectCheckboxes" class="mt-3 space-y-2 hidden">
                                <!-- Will be populated dynamically -->
                            </div>
                        </div>
                    </label>

                    <!-- Export Preview -->
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                        <div class="text-sm font-medium text-gray-700 mb-2">Export will include:</div>
                        <div id="exportPreview" class="text-sm text-gray-600">
                            <!-- Will be updated dynamically -->
                        </div>
                    </div>
                </div>

                <div class="mt-6 flex gap-4 justify-end">
                    <button onclick="closeExportModal()" 
                            class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                        Cancel
                    </button>
                    <button onclick="performExport()" 
                            class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                        üì§ Export
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Clear All Data -->
    <div id="clearAllDataModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="p-6">
                <div class="flex items-center gap-3 mb-4">
                    <div class="bg-red-100 p-3 rounded-full">
                        <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-900">Clear All Data</h2>
                </div>
                
                <div class="space-y-4">
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <p class="text-sm text-red-800 font-medium mb-2">‚ö†Ô∏è This will permanently delete:</p>
                        <ul class="text-sm text-red-700 space-y-1 ml-4">
                            <li id="clearDataProjectCount">‚Ä¢ All projects</li>
                            <li id="clearDataCheckpointCount">‚Ä¢ All checkpoints</li>
                            <li id="clearDataWorklogCount">‚Ä¢ All work logs</li>
                            <li id="clearDataArtifactCount">‚Ä¢ All artifacts</li>
                        </ul>
                    </div>

                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                        <p class="text-sm text-yellow-800">
                            <strong>This cannot be undone.</strong> Export your data first if you need a backup.
                        </p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Type <span class="font-mono bg-gray-100 px-2 py-1 rounded">DELETE</span> to confirm:
                        </label>
                        <input type="text" 
                               id="clearDataConfirmation" 
                               placeholder="Type DELETE here"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                    </div>
                </div>

                <div class="mt-6 flex gap-4 justify-end">
                    <button onclick="closeClearAllDataModal()" 
                            class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                        Cancel
                    </button>
                    <button onclick="performClearAllData()" 
                            id="clearAllDataButton"
                            disabled
                            class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition disabled:bg-gray-300 disabled:cursor-not-allowed">
                        üóëÔ∏è Clear All Data
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: View Checkpoint -->
    <div id="viewCheckpointModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-2xl font-bold" id="viewCheckpointTitle">Checkpoint</h2>
                        <p class="text-gray-500 text-sm mt-1" id="viewCheckpointMeta"></p>
                    </div>
                    <button onclick="closeViewCheckpointModal()" 
                            class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>

                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
                    <pre id="viewCheckpointContent" class="whitespace-pre-wrap font-mono text-sm text-gray-800"></pre>
                </div>

                <div class="flex gap-4 justify-end">
                    <button onclick="editCurrentCheckpoint()" 
                            class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                        ‚úèÔ∏è Edit
                    </button>
                    <button onclick="generateRestorationPromptFromModal()" 
                            class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                        üîÑ Generate Restoration Prompt
                    </button>
                    <button onclick="copyCheckpointToClipboard()" 
                            class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                        üìã Copy to Clipboard
                    </button>

                    <button onclick="downloadCurrentCheckpointTxt()" 
                            class="px-6 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-900 transition">
                        üìÑ Download checkpoint (.txt)
                    </button>
                    <button onclick="deleteCurrentCheckpoint()" 
                            class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
                        üóëÔ∏è Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Restoration Prompt -->
    <div id="restorationPromptModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-2xl font-bold" id="restorationPromptTitle">Restoration Prompt</h2>
                        <p class="text-gray-500 text-sm mt-1" id="restorationPromptMeta"></p>
                    </div>
                    <button onclick="closeRestorationPromptModal()" 
                            class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>

                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
                    <pre id="restorationPromptText" class="whitespace-pre-wrap font-mono text-sm text-gray-800"></pre>
                </div>

                <div class="flex justify-end gap-4">
                    <button onclick="copyRestorationPrompt()" 
                            class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                        üìã Copy Restoration Prompt
                    </button>
                    <button onclick="closeRestorationPromptModal()" 
                            class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">
                        ‚úï Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Work Log Generator -->
    <div id="workLogGeneratorModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <h2 class="text-2xl font-bold mb-4">‚ö° Generate Work Log Template</h2>
                <p class="text-gray-600 mb-6">Create a structured template for documenting your progress</p>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Project</label>
                        <select id="worklogPromptProjectSelect" 
                                onchange="updateWorkLogPromptPreview()"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option value="">Select Project...</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Link to Checkpoint (Optional)
                            <span class="text-gray-500 text-xs ml-1">(Document work done since this checkpoint)</span>
                        </label>
                        <select id="worklogPromptCheckpointSelect" 
                                onchange="updateWorkLogPromptPreview()"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option value="">Not linked to any checkpoint</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Generated Template:</label>
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                            <pre id="generatedWorkLogPrompt" class="whitespace-pre-wrap font-mono text-sm text-gray-800"></pre>
                        </div>
                    </div>
                </div>

                <div class="mt-6 flex gap-4 justify-end">
                    <button onclick="closeWorkLogGeneratorModal()" 
                            class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                        Cancel
                    </button>
                    <button onclick="copyGeneratedWorkLogPrompt()" 
                            class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                        üìã Copy Template
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Save Work Log -->
    <div id="saveWorkLogModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <h2 class="text-2xl font-bold mb-4">Save Work Log</h2>
                <p class="text-gray-600 mb-6">Document what was accomplished in this work session</p>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Project *</label>
                        <select id="worklogProject" 
                                onchange="updateWorkLogCheckpointDropdown()"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option value="">Select Project...</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Title/Summary *
                            <span class="text-gray-500 text-xs ml-1">(Brief description of the work)</span>
                        </label>
                        <input type="text" 
                               id="worklogTitle" 
                               placeholder="e.g., Completed initial research phase"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Link to Checkpoint (Optional)
                            <span class="text-gray-500 text-xs ml-1">(Work done since this checkpoint)</span>
                        </label>
                        <select id="worklogCheckpoint" 
                                onchange="handleWorkLogCheckpointChange()" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option value="">Not linked to any checkpoint</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Work Log Content *
                            <span class="text-gray-500 text-xs ml-1">(Paste AI-generated work log or write your own)</span>
                        </label>
                        <textarea id="worklogContent" 
                                  rows="12" 
                                  oninput="autoFillWorkLogTitleFromContent()" 
                                  placeholder="What was done in this session:
- 
- 

What was produced:
- 

Key decisions made:
- 

Recommendations for next steps:
- "
                                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 font-mono text-sm">
                        </textarea>
                    </div>
                </div>

                <div class="mt-6 flex gap-4 justify-end">
                    <button onclick="closeSaveWorkLogModal()" 
                            class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                        Cancel
                    </button>
                    <button onclick="saveWorkLog()" 
                            class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                        Save Work Log
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: View Work Log -->
    <div id="viewWorkLogModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-2xl font-bold" id="viewWorkLogTitle">Work Log</h2>
                        <p class="text-gray-500 text-sm mt-1" id="viewWorkLogMeta"></p>
                    </div>
                    <button onclick="closeViewWorkLogModal()" 
                            class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>

                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
                    <pre id="viewWorkLogContent" class="whitespace-pre-wrap font-mono text-sm text-gray-800"></pre>
                </div>

                <div class="flex gap-4 justify-end">
                    <button onclick="editCurrentWorkLog()" 
                            class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                        ‚úèÔ∏è Edit
                    </button>
                    <button onclick="copyWorkLogToClipboard()" 
                            class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                        üìã Copy to Clipboard
                    </button>
                    <button onclick="deleteCurrentWorkLog()" 
                            class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
                        üóëÔ∏è Delete
                    </button>
             
        
    <script>

// ===================================
        // DATA STORAGE & STATE MANAGEMENT
        // ===================================

        const STORAGE_KEY = 'vizier_toolkit_data';
        let currentData = null;
        let currentViewingCheckpoint = null;

// Current project (used as a default context across tabs/modals)
const CURRENT_PROJECT_KEY = 'vizier_toolkit_current_project';
let currentProjectId = null;

function loadCurrentProjectId() {
    try {
        const stored = localStorage.getItem(CURRENT_PROJECT_KEY);
        currentProjectId = stored ? stored : null;

        // Validate against current projects list
        if (currentProjectId && (!currentData || !currentData.projects || !currentData.projects.some(p => p.id === currentProjectId))) {
            currentProjectId = null;
            localStorage.removeItem(CURRENT_PROJECT_KEY);
        }
    } catch (e) {
        currentProjectId = null;
    }
}

function persistCurrentProjectId() {
    try {
        if (currentProjectId) localStorage.setItem(CURRENT_PROJECT_KEY, currentProjectId);
        else localStorage.removeItem(CURRENT_PROJECT_KEY);
    } catch (e) { /* ignore */ }
}

function getProjectNameById(projectId) {
    const p = currentData && currentData.projects ? currentData.projects.find(pr => pr.id === projectId) : null;
    return p ? p.name : null;
}

function setCurrentProject(projectId) {
    currentProjectId = projectId || null;
    persistCurrentProjectId();
    updateProjectContextIndicator();
    applyCurrentProjectToFilters();
}

function updateProjectContextIndicator() {
    const el = document.getElementById('projectContextIndicator');
    if (!el) return;

    const name = currentProjectId ? (getProjectNameById(currentProjectId) || 'Unknown Project') : 'All Projects';
    el.textContent = `Project: ${name}`;
}

function applyCurrentProjectToFilters() {
    if (!currentProjectId) return;

    // Default the per-tab filters to the current project (but never change currentProjectId here).
    const checkpointsFilter = document.getElementById('projectFilter');
    if (checkpointsFilter && (checkpointsFilter.value === 'all' || checkpointsFilter.value === '' || checkpointsFilter.value === 'All Projects')) {
        // only set if the option exists
        if ([...checkpointsFilter.options].some(o => o.value === currentProjectId)) {
            checkpointsFilter.value = currentProjectId;
            if (typeof filterCheckpoints === 'function') filterCheckpoints();
        }
    }

    const worklogsFilter = document.getElementById('worklogProjectFilter');
    if (worklogsFilter && (worklogsFilter.value === 'all' || worklogsFilter.value === '' || worklogsFilter.value === 'All Projects')) {
        if ([...worklogsFilter.options].some(o => o.value === currentProjectId)) {
            worklogsFilter.value = currentProjectId;
            if (typeof filterWorkLogs === 'function') filterWorkLogs();
        }
    }

    const artifactsFilter = document.getElementById('artifactProjectFilter');
    if (artifactsFilter && (artifactsFilter.value === 'all' || artifactsFilter.value === '' || artifactsFilter.value === 'All Projects')) {
        if ([...artifactsFilter.options].some(o => o.value === currentProjectId)) {
            artifactsFilter.value = currentProjectId;
            if (typeof filterArtifacts === 'function') filterArtifacts();
        }
    }
}

function applyCurrentProjectToSelect(selectId) {
    if (!currentProjectId) return;
    const sel = document.getElementById(selectId);
    if (!sel) return;
    if ([...sel.options].some(o => o.value === currentProjectId)) {
        sel.value = currentProjectId;
    }
}



        // Initialize data structure
        function initData() {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                currentData = JSON.parse(stored);
                // Ensure artifacts array exists
                if (!currentData.artifacts) {
                    currentData.artifacts = [];
                }
                // Ensure worklogs array exists
                if (!currentData.worklogs) {
                    currentData.worklogs = [];
                }
            } else {
                currentData = {
                    version: "1.2.0-inc2",
                    projects: [],
                    artifacts: [],
                    worklogs: []
                };
                saveData();
            }
        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(currentData));
        }

        // Generate UUID
        function generateId(prefix = 'id') {
            return `${prefix}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        }

        // ===================================
        // PROMPT GENERATOR
        // ===================================

        const PROMPT_TEMPLATES = {
            master: (projectName, taskList) => {
                let base = `Create a checkpoint that includes:
- What we completed
- The current plan
- Important decisions
- Files we used
- What we do next

Project: ${projectName}`;

                if (taskList && taskList.trim()) {
                    base += `

Task list or areas covered in this checkpoint:
${taskList.trim()}`;
                }

                return base;
            },

            task: (taskFocus, projectName, taskList) => {
                let base = `Create a task-specific checkpoint for a new subtask.

Include:
‚Äì A structured task instruction (the Opening Phrase for this subtask)
‚Äì The minimal context this subtask needs
‚Äì What the subtask must accomplish or produce
‚Äì Any constraints, definitions, or reference materials needed
‚Äì Success criteria for the subtask
‚Äì Any risks, ambiguities, or decisions expected during the task

Task focus: ${taskFocus}
Parent project: ${projectName}`;

                if (taskList && taskList.trim()) {
                    base += `

Tasks or bullet points to cover in this subtask:
${taskList.trim()}`;
                }

                base += `

This task-specific checkpoint launches a separate subtask and does not modify the master checkpoint.`;

                return base;
            }
        };

        const WORKLOG_TEMPLATE = (projectName, checkpointLabel) => {
            let template = `Create a Work Log that summarizes the completed work in this session.

Include:
‚Äì What was done in this session
‚Äì What was produced (the deliverable), or where it can be found
‚Äì Key decisions made
‚Äì Any changes to assumptions, definitions, or understanding
‚Äì Any risks, dependencies, or open questions
‚Äì Recommendations for how the main project should proceed

Write the Work Log so it can be copied into the master thread and understood without referencing the rest of this conversation.

Project: ${projectName}`;
            
            if (checkpointLabel) {
                template += `\nWork completed since checkpoint: ${checkpointLabel}`;
            }
            
            template += `\n\nDo not generate a checkpoint. This is a Work Log only.`;
            
            return template;
        };

        function updatePromptPreview() {
            const type = document.querySelector('input[name="checkpointType"]:checked').value;
            const projectId = document.getElementById('promptProjectSelect').value;
            const taskFocusSection = document.getElementById('taskFocusSection');
            const promptDisplay = document.getElementById('generatedPrompt');
            const taskList = document.getElementById('taskListInput')
                ? document.getElementById('taskListInput').value
                : '';

            // Show/hide relevant sections
            taskFocusSection.classList.toggle('hidden', type !== 'task');

            // Get project name
            let projectName = 'Your Project';
            if (projectId) {
                const project = getProject(projectId);
                if (project) projectName = project.name;
            }

            // Generate prompt based on type
            let prompt = '';

            if (type === 'master') {
                prompt = PROMPT_TEMPLATES.master(projectName, taskList);
            } else if (type === 'task') {
                const taskFocus = document.getElementById('taskFocusInput').value.trim() || '[task focus here]';
                prompt = PROMPT_TEMPLATES.task(taskFocus, projectName, taskList);
            }

            promptDisplay.textContent = prompt;
        }

        function copyGeneratedPrompt() {
            const prompt = document.getElementById('generatedPrompt').textContent;
            
            if (!prompt || prompt.includes('[') ) {
                alert('Please fill in all required fields first');
                return;
            }

            navigator.clipboard.writeText(prompt).then(() => {
                showNotification('Prompt copied! Paste into AI chat session.', 'success');
            }).catch(err => {
                // Fallback
                const textarea = document.createElement('textarea');
                textarea.value = prompt;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showNotification('Prompt copied! Paste into AI chat session.', 'success');
            });
        }

        function showPromptGeneratorModal() {
            const modal = document.getElementById('promptGeneratorModal');
            const projectSelect = document.getElementById('promptProjectSelect');

            // Update project dropdown
            projectSelect.innerHTML = '<option value="">Select Project...</option>';
            currentData.projects.forEach(project => {
                projectSelect.innerHTML += `<option value="${escapeHtml(project.id)}">${escapeHtml(project.name)}</option>`;
            });

            // Reset form
            document.querySelector('input[name="checkpointType"][value="master"]').checked = true;
            document.getElementById('taskFocusInput').value = '';
            const taskListEl = document.getElementById('taskListInput');
            if (taskListEl) taskListEl.value = '';

                        applyCurrentProjectToSelect('promptProjectSelect');
modal.classList.remove('hidden');

            // Reset scroll position
            const modalContent = modal.querySelector('.overflow-y-auto');
            if (modalContent) modalContent.scrollTop = 0;

            updatePromptPreview();
        }

        function closePromptGeneratorModal() {
            document.getElementById('promptGeneratorModal').classList.add('hidden');
        }

        // ===================================
        // WORK LOG MANAGEMENT
        // ===================================

        let currentViewingWorkLog = null;

        function showWorkLogGeneratorModal() {
            const modal = document.getElementById('workLogGeneratorModal');
            const projectSelect = document.getElementById('worklogPromptProjectSelect');
            const checkpointSelect = document.getElementById('worklogPromptCheckpointSelect');
            
            // Update project dropdown
            projectSelect.innerHTML = '<option value="">Select Project...</option>';
            currentData.projects.forEach(project => {
                projectSelect.innerHTML += `<option value="${escapeHtml(project.id)}">${escapeHtml(project.name)}</option>`;
            });

            // Reset checkpoint dropdown
            checkpointSelect.innerHTML = '<option value="">Not linked to any checkpoint</option>';
            
                        applyCurrentProjectToSelect('worklogPromptProjectSelect');
modal.classList.remove('hidden');
            updateWorkLogPromptPreview();
        }

        function closeWorkLogGeneratorModal() {
            document.getElementById('workLogGeneratorModal').classList.add('hidden');
        }

        function updateWorkLogPromptPreview() {
            const projectId = document.getElementById('worklogPromptProjectSelect').value;
            const checkpointId = document.getElementById('worklogPromptCheckpointSelect').value;
            const promptDisplay = document.getElementById('generatedWorkLogPrompt');

            // Update checkpoint dropdown when project changes
            const checkpointSelect = document.getElementById('worklogPromptCheckpointSelect');
            if (projectId) {
                const project = getProject(projectId);
                if (project) {
                    checkpointSelect.innerHTML = '<option value="">Not linked to any checkpoint</option>';
                    if (project.checkpoints && project.checkpoints.length > 0) {
                        project.checkpoints.forEach(cp => {
                            const label = getCheckpointLabel(cp);
                            checkpointSelect.innerHTML += `<option value="${escapeHtml(cp.id)}">${escapeHtml(label)}</option>`;
                        });
                    }
                }
            }

            // Get project name and checkpoint label
            let projectName = 'Your Project';
            let checkpointLabel = null;
            
            if (projectId) {
                const project = getProject(projectId);
                if (project) projectName = project.name;
                
                if (checkpointId && project) {
                    const checkpoint = project.checkpoints.find(cp => cp.id === checkpointId);
                    if (checkpoint) {
                        checkpointLabel = getCheckpointLabel(checkpoint);
                    }
                }
            }

            // Generate work log template
            const prompt = WORKLOG_TEMPLATE(projectName, checkpointLabel);
            promptDisplay.textContent = prompt;
        }

        function copyGeneratedWorkLogPrompt() {
            const prompt = document.getElementById('generatedWorkLogPrompt').textContent;
            
            if (!prompt) {
                alert('No template generated');
                return;
            }

            navigator.clipboard.writeText(prompt).then(() => {
                showNotification('Work Log template copied! Paste into AI session.', 'success');
            }).catch(err => {
                // Fallback
                const textarea = document.createElement('textarea');
                textarea.value = prompt;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showNotification('Work Log template copied! Paste into AI session.', 'success');
            });
        }

        function showSaveWorkLogModal() {
            const modal = document.getElementById('saveWorkLogModal');
            const projectSelect = document.getElementById('worklogProject');
            const checkpointSelect = document.getElementById('worklogCheckpoint');
            
            // Update project dropdown
            projectSelect.innerHTML = '<option value="">Select Project...</option>';
            currentData.projects.forEach(project => {
                projectSelect.innerHTML += `<option value="${escapeHtml(project.id)}">${escapeHtml(project.name)}</option>`;
            });

            // Reset form
            document.getElementById('worklogTitle').value = '';
            document.getElementById('worklogContent').value = '';
            checkpointSelect.innerHTML = '<option value="">Not linked to any checkpoint</option>';
            
            // Reset to create mode
            window.editingWorkLogId = null;
            document.querySelector('#saveWorkLogModal h2').textContent = 'Save Work Log';
            document.querySelector('#saveWorkLogModal button[onclick="saveWorkLog()"]').textContent = 'Save Work Log';
            
            modal.classList.remove('hidden');
updateProjectDropdowns(document.getElementById('worklogProject'));
            applyCurrentProjectToSelect('worklogProject');
        }

        function closeSaveWorkLogModal() {
            document.getElementById('saveWorkLogModal').classList.add('hidden');
            
            // Clear editing flag
            window.editingWorkLogId = null;
            
            // Reset modal title and button text
            document.querySelector('#saveWorkLogModal h2').textContent = 'Save Work Log';
            document.querySelector('#saveWorkLogModal button[onclick="saveWorkLog()"]').textContent = 'Save Work Log';
        }

        function saveWorkLog() {
            const projectId = document.getElementById('worklogProject').value;
            const title = document.getElementById('worklogTitle').value.trim();
            const content = document.getElementById('worklogContent').value.trim();
            const checkpointId = document.getElementById('worklogCheckpoint').value;

            if (!projectId) {
                alert('Please select a project');
                return;
            }

            if (!title) {
                alert('Please enter a title');
                return;
            }

            if (!content) {
                alert('Please enter work log content');
                return;
            }

            const project = getProject(projectId);
            if (!project) {
                alert('Project not found');
                return;
            }

            // Check if we're editing an existing work log
            if (window.editingWorkLogId) {
                const worklog = currentData.worklogs.find(wl => wl.id === window.editingWorkLogId);
                if (worklog) {
                    worklog.projectId = projectId;
                    worklog.title = title;
                    worklog.content = content;
                    worklog.checkpointId = checkpointId || null;
                    worklog.timestamp = new Date().toISOString(); // Update timestamp
                    
                    saveData();
                    closeSaveWorkLogModal();
                    renderWorkLogs();
                    showNotification('Work Log updated successfully!', 'success');
                    
                    // Clear editing flag
                    window.editingWorkLogId = null;
                    return;
                }
            }

            // Create new work log
            const worklog = {
                id: generateId('wl'),
                projectId: projectId,
                title: title,
                content: content,
                checkpointId: checkpointId || null,
                timestamp: new Date().toISOString()
            };

            currentData.worklogs.push(worklog);
            saveData();
            closeSaveWorkLogModal();
            renderWorkLogs();
            showNotification('Work Log saved successfully!', 'success');
        }

        function updateWorkLogCheckpointDropdown() {
            const projectId = document.getElementById('worklogProject').value;
            const checkpointSelect = document.getElementById('worklogCheckpoint');

            checkpointSelect.innerHTML = '<option value="">Not linked to any checkpoint</option>';

            if (!projectId) return;

            const project = getProject(projectId);
            if (project && project.checkpoints && project.checkpoints.length > 0) {
                project.checkpoints.forEach(cp => {
                    const label = getCheckpointLabel(cp);
                    checkpointSelect.innerHTML += `<option value="${cp.id}">${escapeHtml(label)}</option>`;
                });
            }
        }

        function handleWorkLogCheckpointChange() {
            const titleInput = document.getElementById('worklogTitle');
            const projectId = document.getElementById('worklogProject').value;
            const checkpointId = document.getElementById('worklogCheckpoint').value;

            // Only auto-fill if the title is still empty
            if (!titleInput || titleInput.value.trim() || !projectId || !checkpointId) return;

            const project = getProject(projectId);
            if (!project || !project.checkpoints) return;

            const checkpoint = project.checkpoints.find(cp => cp.id === checkpointId);
            if (!checkpoint) return;

            const cpLabel = getCheckpointLabel(checkpoint);
            titleInput.value = `Work Log - ${cpLabel}`;
        }

        function autoFillWorkLogTitleFromContent() {
            const titleInput = document.getElementById('worklogTitle');
            const contentEl = document.getElementById('worklogContent');
            if (!titleInput || !contentEl) return;

            // Do not overwrite a user-provided title
            if (titleInput.value && titleInput.value.trim()) return;

            const content = (contentEl.value || '').trim();
            if (!content) return;

            const lines = content.split(/\r?\n/).map(l => l.trim());
            const skipPrefixes = [
                'what was done', 'what was produced', 'key decisions',
                'any changes', 'any risks', 'recommendations', 'end of work log',
                'include:'
            ];

            function normalizeLine(line) {
                if (line.startsWith('- ')) return line.substring(2).trim();
                if (line.startsWith('‚Ä¢ ')) return line.substring(2).trim();
                return line;
            }

            let candidate = '';
            for (let raw of lines) {
                if (!raw) continue;
                const line = normalizeLine(raw);
                const lower = line.toLowerCase();

                // Skip obvious section headers and boilerplate
                if (skipPrefixes.some(p => lower.startsWith(p))) continue;
                if (line.endsWith(':') && line.length < 80) continue;

                // If the paste includes a title-like prefix ("Work Log - ...")
                if (lower.startsWith('work log')) {
                    candidate = line.replace(/^work\s*log\s*[-‚Äì:]+\s*/i, '').trim();
                    if (candidate) break;
                }

                // Otherwise use the first meaningful line
                if (line.length >= 6) {
                    candidate = line;
                    break;
                }
            }

            if (!candidate) return;

            const maxLen = 80;
            if (candidate.length > maxLen) candidate = candidate.substring(0, maxLen - 1) + '‚Ä¶';
            titleInput.value = candidate;
        }



        function renderWorkLogs() {
            const container = document.getElementById('worklogsList');
            const emptyState = document.getElementById('worklogsEmptyState');
            updateProjectContextIndicator();
            
            if (currentData.worklogs.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');

            // Apply filters
            const searchTerm = document.getElementById('worklogSearchInput').value.toLowerCase();
            const projectFilter = document.getElementById('worklogProjectFilter').value;
            const sortOrder = document.getElementById('worklogSortOrder').value;
            const checkpointFilter = window.activeCheckpointFilter || null;

            let filtered = currentData.worklogs.filter(wl => {
                const project = getProject(wl.projectId);
                const matchesSearch = !searchTerm || 
                    wl.title.toLowerCase().includes(searchTerm) ||
                    wl.content.toLowerCase().includes(searchTerm) ||
                    (project && project.name.toLowerCase().includes(searchTerm));
                
                const matchesProject = !projectFilter || wl.projectId === projectFilter;
                const matchesCheckpoint = !checkpointFilter || wl.checkpointId === checkpointFilter;
                
                return matchesSearch && matchesProject && matchesCheckpoint;
            });

            // Sort
            if (sortOrder === 'newest') {
                filtered.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            } else if (sortOrder === 'oldest') {
                filtered.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            } else if (sortOrder === 'project') {
                filtered.sort((a, b) => {
                    const projA = getProject(a.projectId);
                    const projB = getProject(b.projectId);
                    return (projA?.name || '').localeCompare(projB?.name || '');
                });
            }

            // Render
            container.innerHTML = filtered.map(wl => {
                const project = getProject(wl.projectId);
                const projectName = project ? project.name : 'Unknown Project';
                
                let checkpointInfo = '';
                if (wl.checkpointId && project) {
                    const checkpoint = project.checkpoints.find(cp => cp.id === wl.checkpointId);
                    if (checkpoint) {
                        const cpLabel = getCheckpointLabel(checkpoint);
                        checkpointInfo = `<button onclick="viewCheckpoint('${wl.projectId}', '${wl.checkpointId}')" 
                                                  class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded hover:bg-blue-200 transition cursor-pointer"
                                                  title="View checkpoint">
                                            üîó Linked to: ${escapeHtml(cpLabel)}
                                          </button>`;
                    }
                }

                return `
                    <div class="checkpoint-card bg-white rounded-lg shadow-md p-6">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900">${escapeHtml(wl.title)}</h3>
                                <p class="text-sm text-gray-600 mt-1">
                                    <span class="font-medium">${escapeHtml(projectName)}</span>
                                    <span class="mx-2">‚Ä¢</span>
                                    <span>${formatDate(wl.timestamp)}</span>
                                </p>
                                ${checkpointInfo ? `<p class="mt-2">${checkpointInfo}</p>` : ''}
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 border border-gray-200 rounded p-3 mb-4">
                            <pre class="text-xs text-gray-700 whitespace-pre-wrap font-mono line-clamp-4">${escapeHtml(wl.content.substring(0, 300))}${wl.content.length > 300 ? '...' : ''}</pre>
                        </div>

                        <div class="flex gap-2">
                            <button onclick="viewWorkLog('${wl.id}')" 
                                    class="text-sm px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition">
                                View Full Log
                            </button>
                            <button onclick="editWorkLog('${wl.id}')" 
                                    class="text-sm px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition">
                                ‚úèÔ∏è Edit
                            </button>
                            <button onclick="copyWorkLog('${wl.id}')" 
                                    class="text-sm px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition">
                                üìã Copy
                            </button>
                            <button onclick="deleteWorkLog('${wl.id}')" 
                                    class="text-sm px-4 py-2 bg-red-100 text-red-700 rounded hover:bg-red-200 transition">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterWorkLogs() {
            // Clear active checkpoint filter when user manually filters
            window.activeCheckpointFilter = null;
            
            // Hide filter indicator
            const indicator = document.getElementById('activeCheckpointFilterIndicator');
            if (indicator) indicator.classList.add('hidden');
            
            renderWorkLogs();
        }

        function filterWorkLogsByCheckpoint(checkpointId) {
            // Switch to work logs tab
            switchTab('worklogs');
            
            // Find the checkpoint to get its label for display
            let checkpointLabel = 'checkpoint';
            for (const project of currentData.projects) {
                const checkpoint = project.checkpoints.find(cp => cp.id === checkpointId);
                if (checkpoint) {
                    checkpointLabel = getCheckpointLabel(checkpoint);
                    break;
                }
            }
            
            // Clear search input and set a temporary filter
            document.getElementById('worklogSearchInput').value = '';
            
            // Store the filter state
            window.activeCheckpointFilter = checkpointId;
            
            // Show filter indicator
            showCheckpointFilterIndicator(checkpointLabel);
            
            // Render filtered work logs
            renderWorkLogs();
            
            // Show notification
            showNotification(`Showing work logs linked to: ${checkpointLabel}`, 'info');
        }

        function showCheckpointFilterIndicator(label) {
            const indicator = document.getElementById('activeCheckpointFilterIndicator');
            const labelElement = document.getElementById('activeCheckpointFilterLabel');
            
            labelElement.textContent = `"${label}"`;
            indicator.classList.remove('hidden');
        }

        function clearCheckpointFilter() {
            window.activeCheckpointFilter = null;
            
            const indicator = document.getElementById('activeCheckpointFilterIndicator');
            indicator.classList.add('hidden');
            
            renderWorkLogs();
            showNotification('Checkpoint filter cleared', 'info');
        }


        function filterArtifactsByCheckpoint(checkpointId) {
            // Switch to artifacts tab
            switchTab('artifacts');

            // Find the checkpoint label for display
            let checkpointLabel = 'checkpoint';
            for (const project of currentData.projects) {
                const checkpoint = project.checkpoints.find(cp => cp.id === checkpointId);
                if (checkpoint) {
                    checkpointLabel = getCheckpointLabel(checkpoint);
                    break;
                }
            }

            // Clear manual filters
            document.getElementById('artifactSearchInput').value = '';
            document.getElementById('artifactProjectFilter').value = '';
            document.getElementById('artifactTypeFilter').value = '';

            // Store filter state
            window.activeArtifactCheckpointFilter = checkpointId;

            // Show indicator
            showArtifactCheckpointFilterIndicator(checkpointLabel);

            // Render filtered artifacts
            renderArtifacts();

            showNotification(`Showing artifacts linked to: ${checkpointLabel}`, 'info');
        }

        function showArtifactCheckpointFilterIndicator(label) {
            const indicator = document.getElementById('activeArtifactCheckpointFilterIndicator');
            const labelElement = document.getElementById('activeArtifactCheckpointFilterLabel');

            if (!indicator || !labelElement) return;

            labelElement.textContent = `"${label}"`;
            indicator.classList.remove('hidden');
        }

        function clearArtifactCheckpointFilter() {
            window.activeArtifactCheckpointFilter = null;

            const indicator = document.getElementById('activeArtifactCheckpointFilterIndicator');
            if (indicator) indicator.classList.add('hidden');

            renderArtifacts();
            showNotification('Checkpoint filter cleared', 'info');
        }


        function viewWorkLog(worklogId) {
            const worklog = currentData.worklogs.find(wl => wl.id === worklogId);
            if (!worklog) {
                alert('Work Log not found');
                return;
            }

            const project = getProject(worklog.projectId);
            const projectName = project ? project.name : 'Unknown Project';

            document.getElementById('viewWorkLogTitle').textContent = worklog.title;
            
            let meta = `${projectName} ‚Ä¢ ${formatDate(worklog.timestamp)}`;
            if (worklog.checkpointId && project) {
                const checkpoint = project.checkpoints.find(cp => cp.id === worklog.checkpointId);
                if (checkpoint) {
                    const cpLabel = getCheckpointLabel(checkpoint);
                    meta += ` ‚Ä¢ Linked to: ${cpLabel}`;
                }
            }
            document.getElementById('viewWorkLogMeta').textContent = meta;
            document.getElementById('viewWorkLogContent').textContent = worklog.content;
            
            currentViewingWorkLog = worklog;
            document.getElementById('viewWorkLogModal').classList.remove('hidden');
        }

        function closeViewWorkLogModal() {
            document.getElementById('viewWorkLogModal').classList.add('hidden');
            currentViewingWorkLog = null;
        }

        function copyWorkLog(worklogId) {
            const worklog = currentData.worklogs.find(wl => wl.id === worklogId);
            if (!worklog) return;

            navigator.clipboard.writeText(worklog.content).then(() => {
                showNotification('Work Log copied to clipboard!', 'success');
            }).catch(err => {
                const textarea = document.createElement('textarea');
                textarea.value = worklog.content;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showNotification('Work Log copied to clipboard!', 'success');
            });
        }

        function copyWorkLogToClipboard() {
            if (!currentViewingWorkLog) return;
            copyWorkLog(currentViewingWorkLog.id);
        }

        function editWorkLog(worklogId) {
            const worklog = currentData.worklogs.find(wl => wl.id === worklogId);
            if (!worklog) {
                alert('Work Log not found');
                return;
            }
            
            // Open save modal in edit mode
            document.getElementById('worklogTitle').value = worklog.title;
            document.getElementById('worklogContent').value = worklog.content;
            document.getElementById('worklogProject').value = worklog.projectId;
            
            // Update checkpoint dropdown for this project
            updateWorkLogCheckpointDropdown();
            
            // Set checkpoint if linked
            if (worklog.checkpointId) {
                document.getElementById('worklogCheckpoint').value = worklog.checkpointId;
            }
            
            // Store the worklog ID for updating
            window.editingWorkLogId = worklogId;
            
            // Change modal title and button text
            document.querySelector('#saveWorkLogModal h2').textContent = 'Edit Work Log';
            document.querySelector('#saveWorkLogModal button[onclick="saveWorkLog()"]').textContent = 'Update Work Log';
            
            // Show modal
            document.getElementById('saveWorkLogModal').classList.remove('hidden');
        }

        function editCurrentWorkLog() {
            if (!currentViewingWorkLog) return;
            
            closeViewWorkLogModal();
            editWorkLog(currentViewingWorkLog.id);
        }

        function deleteWorkLog(worklogId) {
            if (!confirm('Are you sure you want to delete this work log?')) return;

            const index = currentData.worklogs.findIndex(wl => wl.id === worklogId);
            if (index === -1) return;

            currentData.worklogs.splice(index, 1);
            saveData();
            renderWorkLogs();
            showNotification('Work Log deleted', 'info');
        }

        function deleteCurrentWorkLog() {
            if (!currentViewingWorkLog) return;
            
            closeViewWorkLogModal();
            deleteWorkLog(currentViewingWorkLog.id);
        }

        // ===================================
        // PROJECT MANAGEMENT
        // ===================================

        function createProject(nameOverride) {
            const rawName = typeof nameOverride === 'string'
                ? nameOverride
                : document.getElementById('newProjectName')?.value;

            const name = rawName ? rawName.trim() : '';

            if (!name) {
                alert('Please enter a project name');
                return;
            }

            const project = {
                id: generateId('proj'),
                name,
                checkpoints: [],
                lastActivity: new Date().toISOString()
            };

            currentData.projects.push(project);
            saveData();
            updateProjectDropdowns();
            renderCheckpoints();
                    renderWorkLogs();
                    renderArtifacts();

            renderWorkLogs();
            renderArtifacts();

            if (!nameOverride) {
                // Only close this if we came from the old "New Project" modal
                closeNewProjectModal();
            }

            showNotification('Project created successfully!', 'success');
        }

        
function showProjectManagerModal() {
    const modal = document.getElementById('projectManagerModal');
    const list = document.getElementById('projectManagerList');

    if (!modal || !list) return;

    if (!currentData.projects || currentData.projects.length === 0) {
        list.innerHTML = `<p class="text-gray-500 text-sm">No projects yet. Create your first project below.</p>`;
    } else {
        // All Projects selector
        const allActive = !currentProjectId;
        let html = `
            <div class="flex items-center justify-between border border-gray-200 rounded-lg px-3 py-2 mb-2 ${allActive ? 'bg-indigo-50 border-indigo-200' : ''}">
                <div>
                    <div class="font-medium text-gray-900">All Projects</div>
                    <div class="text-xs text-gray-500">Use across all projects</div>
                </div>
                <button onclick="setCurrentProject(null); closeProjectManagerModal();"
                        class="px-3 py-1 text-sm ${allActive ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-700'} rounded-lg hover:bg-indigo-700 hover:text-white transition">
                    ${allActive ? 'Selected' : 'Select'}
                </button>
            </div>
        `;

        currentData.projects.forEach(project => {
            const checkpointCount = (project.checkpoints || []).length;
            const worklogCount = currentData.worklogs.filter(w => w.projectId === project.id).length;
            const lastActivity = project.lastActivity ? formatDate(project.lastActivity) : 'N/A';
            const isActive = currentProjectId === project.id;

            html += `
                <div class="flex items-center justify-between border border-gray-200 rounded-lg px-3 py-2 ${isActive ? 'bg-indigo-50 border-indigo-200' : ''}">
                    <div>
                        <div class="font-medium text-gray-900">${escapeHtml(project.name)}</div>
                        <div class="text-xs text-gray-500">
                            ${checkpointCount} checkpoints ‚Ä¢ ${worklogCount} work logs ‚Ä¢ Last activity: ${lastActivity}
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="setCurrentProject('${project.id}'); closeProjectManagerModal();"
                                class="px-3 py-1 text-sm ${isActive ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-700'} rounded-lg hover:bg-indigo-700 hover:text-white transition">
                            ${isActive ? 'Selected' : 'Select'}
                        </button>
                        <button onclick="deleteProject('${project.id}')"
                                class="px-3 py-1 text-sm bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
                            Delete
                        </button>
                    </div>
                </div>`;
        });

        list.innerHTML = html;
    }

    document.getElementById('projectManagerNewProjectName').value = '';
    modal.classList.remove('hidden');
}function closeProjectManagerModal() {
            const modal = document.getElementById('projectManagerModal');
            if (modal) modal.classList.add('hidden');
        }

        function createProjectFromManager() {
            const input = document.getElementById('projectManagerNewProjectName');
            if (!input) return;

            const name = input.value.trim();
            if (!name) {
                alert('Please enter a project name');
                return;
            }

            createProject(name);
            input.value = '';
            showProjectManagerModal(); // refresh list
        }

        function deleteProject(projectId) {
            if (!confirm('Delete this project and all its checkpoints, work logs, and artifacts? This cannot be undone.')) {
                return;
            }

            // Remove project
            currentData.projects = currentData.projects.filter(p => p.id !== projectId);

            // Remove related work logs and artifacts
            if (currentData.worklogs) {
                currentData.worklogs = currentData.worklogs.filter(wl => wl.projectId !== projectId);
            }
            if (currentData.artifacts) {
                currentData.artifacts = currentData.artifacts.filter(a => a.projectId !== projectId);
            }

            saveData();
            updateProjectDropdowns();
            renderCheckpoints();
            renderWorkLogs();
            renderArtifacts();
            showNotification('Project and related data deleted.', 'info');

            showProjectManagerModal(); // refresh list if modal still open
        }



        function getProject(projectId) {
            return currentData.projects.find(p => p.id === projectId);
        }

        function getCheckpointLabel(checkpoint) {
            // Return label if it exists and is not empty
            if (checkpoint.label && checkpoint.label.trim()) {
                return checkpoint.label.trim();
            }
            
            // Otherwise, extract first line from content (up to 50 chars)
            if (checkpoint.content) {
                const firstLine = checkpoint.content.trim().split('\n')[0];
                if (firstLine.length > 50) {
                    return firstLine.substring(0, 50) + '...';
                }
                return firstLine || 'Untitled Checkpoint';
            }
            
            return 'Untitled Checkpoint';
        }

        function updateProjectDropdowns() {
            const projectFilter = document.getElementById('projectFilter');
            const checkpointProject = document.getElementById('checkpointProject');
            const worklogProjectFilter = document.getElementById('worklogProjectFilter');
            const worklogProject = document.getElementById('worklogProject');

            // Update checkpoint filter dropdown
            projectFilter.innerHTML = '<option value="">All Projects</option>';
            currentData.projects.forEach(project => {
                projectFilter.innerHTML += `<option value="${escapeHtml(project.id)}">${escapeHtml(project.name)}</option>`;
            });

            // Update checkpoint save dropdown
            checkpointProject.innerHTML = '<option value="">Select Project...</option>';
            currentData.projects.forEach(project => {
                checkpointProject.innerHTML += `<option value="${escapeHtml(project.id)}">${escapeHtml(project.name)}</option>`;
            });
            
            // Update work log filter dropdown
            if (worklogProjectFilter) {
                worklogProjectFilter.innerHTML = '<option value="">All Projects</option>';
                currentData.projects.forEach(project => {
                    worklogProjectFilter.innerHTML += `<option value="${escapeHtml(project.id)}">${escapeHtml(project.name)}</option>`;
                });
            }
            
            // Update work log save dropdown
            if (worklogProject) {
                worklogProject.innerHTML = '<option value="">Select Project...</option>';
                currentData.projects.forEach(project => {
                    worklogProject.innerHTML += `<option value="${escapeHtml(project.id)}">${escapeHtml(project.name)}</option>`;
                });
            }
            
            // Update artifacts filter
            updateArtifactDropdowns();
        }

        // ===================================
        // CHECKPOINT MANAGEMENT
        // ===================================

        function saveCheckpoint() {
            const projectId = document.getElementById('checkpointProject').value;
            const content = document.getElementById('checkpointContent').value.trim();
            const label = document.getElementById('checkpointLabel').value.trim();
            const reviewEnabled = document.getElementById('reviewArtifacts').checked;

            if (!projectId) {
                alert('Please select a project');
                return;
            }

            if (!content) {
                alert('Please paste checkpoint content');
                return;
            }

            const project = getProject(projectId);
            if (!project) {
                alert('Project not found');
                return;
            }

            // Validate checkpoint
            const validation = validateCheckpointContent(content);

            // Check if we're editing an existing checkpoint
            if (window.editingCheckpoint) {
                const checkpoint = project.checkpoints.find(cp => cp.id === window.editingCheckpoint.checkpointId);
                if (checkpoint) {
                    checkpoint.content = content;
                    checkpoint.label = label;
                    checkpoint.timestamp = new Date().toISOString();
                    checkpoint.validation = validation;
                    checkpoint.lastUsed = new Date().toISOString();
                    
                    saveData();
                    closeSaveCheckpointModal();
                    renderCheckpoints();
                    
                    if (validation.isComplete) {
                        showNotification('Checkpoint updated successfully! ‚úì', 'success');
                    } else {
                        showNotification('Checkpoint updated (incomplete - missing sections)', 'warning');
                    }
                    
                    // Clear editing flag
                    window.editingCheckpoint = null;
                    return;
                }
            }

            // Create new checkpoint
            const checkpoint = {
                id: generateId('cp'),
                content: content,
                label: label,
                timestamp: new Date().toISOString(),
                validation: validation,
                lastUsed: new Date().toISOString()
            };

            project.checkpoints.push(checkpoint);
            
            // Handle artifacts based on review mode
            if (reviewEnabled && pendingArtifacts.length > 0) {
                // Use only checked artifacts
                const checkboxes = document.querySelectorAll('.artifact-checkbox');
                let savedCount = 0;
                checkboxes.forEach((checkbox) => {
                    const index = parseInt(checkbox.getAttribute('data-artifact-index'));
                    if (checkbox.checked && pendingArtifacts[index]) {
                        const artData = pendingArtifacts[index];
                        saveApprovedArtifact(artData, checkpoint.id);
                        savedCount++;
                    }
                });
                console.log(`Saved ${savedCount} out of ${pendingArtifacts.length} artifacts`);
                pendingArtifacts = []; // Clear pending
            } else if (!reviewEnabled) {
                // Auto-extract without review (old behavior)
                extractAndSaveArtifactsFromCheckpoint(checkpoint, projectId);
            }
            
            saveData();
            closeSaveCheckpointModal();
            renderCheckpoints();
            
            if (validation.isComplete) {
                showNotification('Checkpoint saved successfully! ‚úì', 'success');
            } else {
                showNotification('Checkpoint saved (incomplete - missing sections)', 'warning');
            }
        }

        function saveApprovedArtifact(artData, checkpointId) {
            // Check if artifact already exists
            const existing = currentData.artifacts.find(a => 
                a.projectId === artData.projectId && 
                (a.originalName === artData.filename || 
                 (a.label && a.label.toLowerCase() === artData.description.toLowerCase()))
            );
            
            if (!existing) {
                // Create new artifact
                const artifact = {
                    id: generateId('art'),
                    projectId: artData.projectId,
                    originalName: artData.filename,
                    suggestedName: artData.filename,
                    label: artData.description,
                    type: artData.type,
                    externalPath: '',
                    linkedCheckpoints: [checkpointId],
                    version: currentData.artifacts.filter(a => a.projectId === artData.projectId).length + 1,
                    created: new Date().toISOString(),
                    lastUsed: new Date().toISOString(),
                    autoExtracted: true
                };
                currentData.artifacts.push(artifact);
                console.log('Saved approved artifact:', artData.filename);
            } else {
                // Link to existing
                if (!existing.linkedCheckpoints.includes(checkpointId)) {
                    existing.linkedCheckpoints.push(checkpointId);
                    existing.lastUsed = new Date().toISOString();
                }
            }
        }

        function extractAndSaveArtifactsFromCheckpoint(checkpoint, projectId) {
            // This is the non-interactive extraction for when review is disabled
            const artifacts = extractArtifactsFromContent(checkpoint.content, projectId);
            
            artifacts.forEach(artData => {
                saveApprovedArtifact(artData, checkpoint.id);
            });
            
            console.log(`Auto-extracted ${artifacts.length} artifacts`);
        }

        
        function extractSection(content, sectionNames) {
            // Find section by looking for any of the section names
            for (const sectionName of sectionNames) {
                const regex = new RegExp(`${sectionName}[:\s]*\n([\\s\\S]*?)(?=\n[A-Z][A-Z\\s]+:|$)`, 'i');
                const match = content.match(regex);
                if (match) {
                    return match[1].trim();
                }
            }
            return null;
        }

        function createArtifactFromFilename(filename, projectId, checkpointId) {
            const project = getProject(projectId);
            
            // Extract extension
            const parts = filename.split('.');
            const ext = parts.length > 1 ? parts[parts.length - 1].toLowerCase() : '';
            
            // Determine type from extension
            let type = 'other';
            if (['png', 'jpg', 'jpeg', 'svg', 'gif', 'webp'].includes(ext)) {
                type = 'image';
            } else if (['pdf', 'docx', 'doc', 'txt', 'md'].includes(ext)) {
                type = 'document';
            } else if (['csv', 'xlsx', 'xls', 'tsv'].includes(ext)) {
                type = 'data';
            } else if (['py', 'js', 'html', 'css', 'json', 'jsx', 'ts'].includes(ext)) {
                type = 'code';
            }
            
            // Count existing artifacts for versioning
            const existingCount = currentData.artifacts.filter(a => 
                a.projectId === projectId && a.type === type
            ).length;
            const version = existingCount + 1;
            
            return {
                id: generateId('art'),
                projectId: projectId,
                originalName: filename,
                suggestedName: filename, // Keep original unless user manually renames
                label: `Auto-extracted from checkpoint`,
                type: type,
                externalPath: '',
                linkedCheckpoints: [checkpointId],
                version: version,
                created: new Date().toISOString(),
                lastUsed: new Date().toISOString(),
                autoExtracted: true // Flag to show it was auto-created
            };
        }

        function validateCheckpointContent(content) {
            const requiredSections = [
                "What we completed",
                "current plan",
                "Important decisions",
                "Files we used",
                "What we do next"
            ];

            const lower = content.toLowerCase();

            function hasSection(label) {
                const key = label.toLowerCase();

                if (key === "files we used") {
                    // Delegate to the same logic used for artifact extraction.
                    // If extractFilesSection can find a files/artifacts section,
                    // we consider this checkpoint to have a "Files we used" section.
                    const filesSection = extractFilesSection(content);
                    return !!(filesSection && filesSection.trim().length > 0);
                }

                if (key === "current plan") {
                    // Accept "current plan" or variants that contain that phrase
                    return lower.includes("current plan");
                }

                return lower.includes(key);
            }

            const foundSections = requiredSections.filter(section => hasSection(section));
            const missingSections = requiredSections.filter(section => !hasSection(section));

            return {
                isComplete: foundSections.length === requiredSections.length,
                foundCount: foundSections.length,
                totalCount: requiredSections.length,
                missingSections: missingSections
            };
        }

        function validateCheckpoint() {
            const content = document.getElementById('checkpointContent').value.trim();
            
            if (!content) {
                alert('Please paste checkpoint content first');
                return;
            }

            const validation = validateCheckpointContent(content);
            const resultsDiv = document.getElementById('validationResults');
            const detailsDiv = document.getElementById('validationDetails');

            resultsDiv.classList.remove('hidden');

            let html = `
                <div class="flex items-center gap-2 mb-2">
                    ${validation.isComplete 
                        ? '<span class="text-green-600">‚úì Complete</span>' 
                        : '<span class="text-yellow-600">‚ö† Incomplete</span>'}
                    <span class="text-gray-600">(${validation.foundCount}/${validation.totalCount} sections found)</span>
                </div>
            `;

            if (!validation.isComplete) {
                html += '<div class="text-sm text-gray-600 mt-2">Missing sections:</div>';
                validation.missingSections.forEach(section => {
                    html += `<div class="text-sm text-red-600">‚úó ${section}</div>`;
                });
            } else {
                html += '<div class="text-sm text-green-600">All required sections present!</div>';
            }

            detailsDiv.innerHTML = html;
        }

        function editCheckpoint(projectId, checkpointId) {
            const project = getProject(projectId);
            if (!project) {
                alert('Project not found');
                return;
            }
            
            const checkpoint = project.checkpoints.find(cp => cp.id === checkpointId);
            if (!checkpoint) {
                alert('Checkpoint not found');
                return;
            }
            
            // Open save modal in edit mode
            document.getElementById('checkpointLabel').value = checkpoint.label || '';
            document.getElementById('checkpointContent').value = checkpoint.content;
            document.getElementById('checkpointProject').value = projectId;
            
            // Store the checkpoint info for updating
            window.editingCheckpoint = { projectId, checkpointId };
            
            // Change modal title and button text
            document.querySelector('#saveCheckpointModal h2').textContent = 'Edit Checkpoint';
            document.querySelector('#saveCheckpointModal button[onclick="saveCheckpoint()"]').textContent = 'Update Checkpoint';
            
            // Show modal
            document.getElementById('saveCheckpointModal').classList.remove('hidden');
        }

        function editCurrentCheckpoint() {
            if (!currentViewingCheckpoint) return;
            
            closeViewCheckpointModal();
            editCheckpoint(currentViewingCheckpoint.projectId, currentViewingCheckpoint.checkpointId);
        }

        function deleteCheckpoint(projectId, checkpointId) {
            if (!confirm('Delete this checkpoint? Any linked work logs will remain, but their checkpoint link will be cleared.')) {
                return;
            }

const project = getProject(projectId);
            if (!project) return;

            project.checkpoints = project.checkpoints.filter(cp => cp.id !== checkpointId);

            // Clear links from work logs that referenced this checkpoint
            currentData.worklogs = currentData.worklogs.map(wl => {
                if (wl.checkpointId === checkpointId) {
                    return { ...wl, checkpointId: null };
                }
                return wl;
            });

            saveData();
            closeViewCheckpointModal();
            renderCheckpoints();
            showNotification('Checkpoint deleted', 'info');
        }

        function deleteCurrentCheckpoint() {
            if (currentViewingCheckpoint) {
                deleteCheckpoint(currentViewingCheckpoint.projectId, currentViewingCheckpoint.checkpointId);
            }
        }

        // ===================================
        // ARTIFACT MANAGEMENT
        // ===================================

        let pendingArtifacts = []; // Artifacts waiting for user approval

        function previewExtractedArtifacts() {
            const content = document.getElementById('checkpointContent').value.trim();
            const projectId = document.getElementById('checkpointProject').value;
            
            if (!content) {
                alert('Please paste checkpoint content first');
                return;
            }
            
            if (!projectId) {
                alert('Please select a project first');
                return;
            }
            
            // Extract artifacts from content
            pendingArtifacts = extractArtifactsFromContent(content, projectId);
            
            const previewDiv = document.getElementById('extractedArtifactsPreview');
            const listDiv = document.getElementById('extractedArtifactsList');
            const countSpan = document.getElementById('artifactCount');
            
            if (pendingArtifacts.length === 0) {
                alert('No files found in "Files we used" section');
                previewDiv.classList.add('hidden');
                return;
            }
            
            // Show preview
            previewDiv.classList.remove('hidden');
            countSpan.textContent = `(${pendingArtifacts.length} found)`;
            
            // Render list with checkboxes
            listDiv.innerHTML = pendingArtifacts.map((art, index) => `
                <label class="flex items-start gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
                    <input type="checkbox" 
                           checked 
                           data-artifact-index="${index}"
                           class="artifact-checkbox mt-1 w-4 h-4 text-indigo-600 rounded">
                    <div class="flex-1 text-sm">
                        <div class="font-medium text-gray-800">${escapeHtml(art.filename)}</div>
                        <div class="text-gray-600 text-xs">${escapeHtml(art.description)}</div>
                        <div class="text-gray-500 text-xs">Type: ${art.type}</div>
                    </div>
                </label>
            `).join('');
        }

        function extractArtifactsFromContent(content, projectId) {
            // Find "FILES WE USED" section with flexible matching
            const filesSection = extractFilesSection(content);
            
            if (!filesSection) {
                console.log('No files section found');
                return [];
            }
            
            console.log('Files section found:', filesSection.substring(0, 200));
            
            const artifacts = [];
            const lines = filesSection.split('\n');
            
            lines.forEach((line, index) => {
                line = line.trim();
                if (!line || line.length < 3) return;
                
                // Skip section header
                if (line.toLowerCase().match(/^files?\s+(we\s+)?used/i)) return;
                
                // Remove common bullet formats
                const cleanLine = line.replace(/^[-‚Ä¢*‚úì\d]+[.)\s]+/, '').trim();
                if (!cleanLine) return;
                
                // Try to find actual filename with extension
                const filenameMatch = cleanLine.match(/([a-zA-Z0-9_\-\.]+\.[a-zA-Z0-9]{2,5})\b/);
                
                let filename, description;
                
                if (filenameMatch) {
                    // Found actual filename
                    filename = filenameMatch[1];
                    description = cleanLine.replace(filename, '').replace(/^[-:,\s]+/, '').trim() || filename;
                } else {
                    // No extension found, use whole line as description
                    filename = `file_${artifacts.length + 1}`;
                    description = cleanLine;
                }
                
                // Infer type
                const type = inferFileType(filename, description);
                
                artifacts.push({
                    filename: filename,
                    description: description,
                    type: type,
                    projectId: projectId
                });
            });
            
            return artifacts;
        }

        function extractFilesSection(content) {
            // Robust, line-based section matching for file lists
            const lines = content.split('\n');
            const headerRegex = /(FILES?\s+WE\s+USED|FILES?\s+USED|ARTIFACTS?)/i;
            
            let startIndex = -1;
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // Allow headers like "FILES WE USED", "Files used", "Artifacts", with optional punctuation
                if (headerRegex.test(line.replace(/[:\-‚Äì‚Äî]+$/, ''))) {
                    startIndex = i + 1;
                    break;
                }
            }
            
            if (startIndex === -1) {
                return null;
            }
            
            const collected = [];
            for (let j = startIndex; j < lines.length; j++) {
                const rawLine = lines[j];
                const trimmed = rawLine.trim();
                
                if (!trimmed) {
                    // allow occasional blank lines inside the section; don't break immediately
                    continue;
                }
                
                // Detect obvious new top-level headings (all caps words, often the other checkpoint sections)
                if (/^[A-Z][A-Z0-9\s\-‚Äì‚Äî]+$/.test(trimmed) && !/^[\-‚Ä¢*]/.test(trimmed)) {
                    break;
                }
                
                collected.push(rawLine);
            }
            
            const sectionText = collected.join('\n').trim();
            return sectionText || null;
        }
        
        function inferFileType(filename, description) {
            const lower = (filename + ' ' + description).toLowerCase();
            
            if (lower.match(/\.(png|jpg|jpeg|gif|svg|webp|bmp)/)) return 'image';
            if (lower.match(/\.(pdf|docx?|txt|md|rtf)/)) return 'document';
            if (lower.match(/\.(csv|xlsx?|tsv|json)/)) return 'data';
            if (lower.match(/\.(py|js|html|css|java|cpp|ts)/)) return 'code';
            if (lower.match(/image|photo|picture|screenshot|diagram/)) return 'image';
            if (lower.match(/document|report|pdf|file/)) return 'document';
            if (lower.match(/data|spreadsheet|csv|table/)) return 'data';
            if (lower.match(/code|script|program/)) return 'code';
            if (lower.match(/video|footage|recording/)) return 'image'; // Use image icon for video
            
            return 'other';
        }

        function saveArtifact() {
            const projectId = document.getElementById('artifactProject').value;
            const originalName = document.getElementById('artifactOriginalName').value.trim();
            const suggestedName = document.getElementById('artifactSuggestedName').value.trim();
            const label = document.getElementById('artifactLabel').value.trim();
            const type = document.getElementById('artifactType').value;
            const path = document.getElementById('artifactPath').value.trim();
            const checkpointLink = document.getElementById('artifactCheckpointLink').value;

            if (!projectId) {
                alert('Please select a project');
                return;
            }

            if (!originalName) {
                alert('Please enter the original filename');
                return;
            }

            const project = getProject(projectId);
            if (!project) {
                alert('Project not found');
                return;
            }

            // Determine version number
            const existingArtifacts = currentData.artifacts.filter(a => 
                a.projectId === projectId && 
                a.suggestedName.startsWith(suggestedName.split('_v')[0])
            );
            const version = existingArtifacts.length + 1;

            const artifact = {
                id: generateId('art'),
                projectId: projectId,
                originalName: originalName,
                suggestedName: suggestedName || originalName,
                label: label,
                type: type,
                externalPath: path,
                linkedCheckpoints: checkpointLink ? [checkpointLink] : [],
                version: version,
                created: new Date().toISOString(),
                lastUsed: new Date().toISOString()
            };

            currentData.artifacts.push(artifact);
            saveData();
            closeAddArtifactModal();
            renderArtifacts();
            showNotification('Artifact added successfully!', 'success');
        }

        function suggestArtifactName() {
            const projectId = document.getElementById('artifactProject').value;
            const originalName = document.getElementById('artifactOriginalName').value.trim();
            
            if (!projectId || !originalName) return;

            const project = getProject(projectId);
            if (!project) return;

            // Extract extension
            const parts = originalName.split('.');
            const ext = parts.length > 1 ? parts[parts.length - 1] : '';
            
            // Get file type from extension
            let fileType = 'file';
            if (['png', 'jpg', 'jpeg', 'svg', 'gif'].includes(ext.toLowerCase())) {
                fileType = 'image';
            } else if (['pdf', 'docx', 'doc', 'txt', 'md'].includes(ext.toLowerCase())) {
                fileType = 'document';
            } else if (['csv', 'xlsx', 'xls'].includes(ext.toLowerCase())) {
                fileType = 'data';
            } else if (['py', 'js', 'html', 'css', 'json'].includes(ext.toLowerCase())) {
                fileType = 'code';
            }

            // Count existing artifacts for versioning
            const existingCount = currentData.artifacts.filter(a => a.projectId === projectId).length;
            const version = existingCount + 1;

            // Generate suggestion
            const cleanProjectName = project.name.replace(/\s+/g, '');
            const suggested = `${cleanProjectName}_${fileType}_v${version}.${ext}`;

            document.getElementById('artifactSuggestedName').value = suggested;
        }

        function renderArtifacts() {
            const container = document.getElementById('artifactsList');
            const emptyState = document.getElementById('artifactsEmptyState');
            updateProjectContextIndicator();
            
            if (currentData.artifacts.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');

            // Apply filters
            const searchTerm = document.getElementById('artifactSearchInput').value.toLowerCase();
            const projectFilter = document.getElementById('artifactProjectFilter').value;
            const typeFilter = document.getElementById('artifactTypeFilter').value;
            const checkpointFilter = window.activeArtifactCheckpointFilter || null;

            let filtered = currentData.artifacts.filter(art => {
                const matchesSearch = !searchTerm || 
                    art.originalName.toLowerCase().includes(searchTerm) ||
                    art.suggestedName.toLowerCase().includes(searchTerm) ||
                    (art.label && art.label.toLowerCase().includes(searchTerm));
                
                const matchesProject = !projectFilter || art.projectId === projectFilter;
                const matchesType = !typeFilter || art.type === typeFilter;
                const matchesCheckpoint = !checkpointFilter || (art.linkedCheckpoints || []).includes(checkpointFilter);

                return matchesSearch && matchesProject && matchesType && matchesCheckpoint;
            });

            // Sort by most recent
            filtered.sort((a, b) => new Date(b.created) - new Date(a.created));

            // Render
            container.innerHTML = filtered.map(art => {
                const project = getProject(art.projectId);
                const projectName = project ? project.name : 'Unknown Project';
                
                const typeIcons = {
                    'document': 'üìÑ',
                    'image': 'üñºÔ∏è',
                    'data': 'üìä',
                    'code': 'üíª',
                    'other': 'üìé'
                };
                
                const icon = typeIcons[art.type] || 'üìé';

                return `
                    <div class="checkpoint-card bg-white rounded-lg shadow-md p-6">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-2xl">${icon}</span>
                                    <h3 class="text-lg font-semibold text-gray-800">
                                        ${escapeHtml(art.suggestedName || art.originalName)}
                                    </h3>
                                    ${art.autoExtracted ? '<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">Auto</span>' : ''}
                                </div>
                                ${art.label && art.label !== 'Auto-extracted from checkpoint' ? `<p class="text-sm text-gray-600 mb-1">${escapeHtml(art.label)}</p>` : ''}
                                ${art.originalName !== art.suggestedName ? `
                                    <p class="text-xs text-gray-500 mb-1">
                                        Original: ${escapeHtml(art.originalName)}
                                    </p>
                                ` : ''}
                                <p class="text-xs text-gray-500">
                                    ${escapeHtml(projectName)} ‚Ä¢ v${art.version} ‚Ä¢ ${formatDate(art.created)}
                                </p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="editArtifact('${art.id}')" 
                                        class="text-blue-600 hover:text-blue-800 text-sm"
                                        title="Edit artifact">
                                    ‚úèÔ∏è
                                </button>
                                <button onclick="deleteArtifact('${art.id}')" 
                                        class="text-red-600 hover:text-red-800 text-sm"
                                        title="Delete artifact">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                        
                        ${art.linkedCheckpoints.length > 0 ? `
                            <div class="mt-3 pt-3 border-t border-gray-200">
                                <p class="text-xs text-gray-600">
                                    üîó Linked to ${art.linkedCheckpoints.length} checkpoint(s)
                                </p>
                            </div>
                        ` : ''}
                        
                        ${art.externalPath ? `
                            <div class="mt-2">
                                <p class="text-xs text-gray-500">
                                    üìÅ ${escapeHtml(art.externalPath)}
                                </p>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function filterArtifacts() {
            // Clear active checkpoint filter when user manually filters
            window.activeArtifactCheckpointFilter = null;

            // Hide filter indicator
            const indicator = document.getElementById('activeArtifactCheckpointFilterIndicator');
            if (indicator) indicator.classList.add('hidden');

            renderArtifacts();
        }

        function deleteArtifact(artifactId) {
            if (!confirm('Are you sure you want to delete this artifact?')) {
                return;
            }

            currentData.artifacts = currentData.artifacts.filter(a => a.id !== artifactId);
            saveData();
            renderArtifacts();
            showNotification('Artifact deleted', 'info');
        }

        function editArtifact(artifactId) {
            // TODO: Implement edit functionality if needed
            // For now, user can delete and re-add, or we can add edit modal later
            showNotification('Edit feature coming in Phase 2', 'info');
        }

        function showAddArtifactModal() {
            const modal = document.getElementById('addArtifactModal');
            const projectSelect = document.getElementById('artifactProject');
            const checkpointSelect = document.getElementById('artifactCheckpointLink');
            
            // Update project dropdown
            projectSelect.innerHTML = '<option value="">Select Project...</option>';
            currentData.projects.forEach(project => {
                projectSelect.innerHTML += `<option value="${escapeHtml(project.id)}">${escapeHtml(project.name)}</option>`;
            });

            // Update checkpoint dropdown
            checkpointSelect.innerHTML = '<option value="">Not linked to any checkpoint</option>';
            currentData.projects.forEach(project => {
                if (project.checkpoints && project.checkpoints.length > 0) {
                    project.checkpoints.forEach(cp => {
                        const label = cp.label || 'Checkpoint';
                        checkpointSelect.innerHTML += `<option value="${escapeHtml(cp.id)}">${escapeHtml(project.name)}: ${escapeHtml(label)}</option>`;
                    });
                }
            });

            // Reset form
            document.getElementById('artifactOriginalName').value = '';
            document.getElementById('artifactSuggestedName').value = '';
            document.getElementById('artifactLabel').value = '';
            document.getElementById('artifactType').value = 'document';
            document.getElementById('artifactPath').value = '';
            
                        applyCurrentProjectToSelect('artifactProject');
modal.classList.remove('hidden');
            
            // Reset scroll
            const modalContent = modal.querySelector('.overflow-y-auto');
            if (modalContent) modalContent.scrollTop = 0;
        }

        function closeAddArtifactModal() {
            document.getElementById('addArtifactModal').classList.add('hidden');
        }

        function updateArtifactDropdowns() {
            const projectFilter = document.getElementById('artifactProjectFilter');
            
            projectFilter.innerHTML = '<option value="">All Projects</option>';
            currentData.projects.forEach(project => {
                projectFilter.innerHTML += `<option value="${escapeHtml(project.id)}">${escapeHtml(project.name)}</option>`;
            });
        }

        // ===================================
        // TAB SWITCHING
        // ===================================

        function switchTab(tabName) {
            // Hide all tabs
            document.getElementById('checkpointsTab').classList.add('hidden');
            document.getElementById('worklogsTab').classList.add('hidden');
            document.getElementById('artifactsTab').classList.add('hidden');
            
            // Remove active state from all tab buttons
            document.getElementById('tabCheckpoints').classList.remove('border-white');
            document.getElementById('tabCheckpoints').classList.add('border-transparent');
            document.getElementById('tabWorklogs').classList.remove('border-white');
            document.getElementById('tabWorklogs').classList.add('border-transparent');
            document.getElementById('tabArtifacts').classList.remove('border-white');
            document.getElementById('tabArtifacts').classList.add('border-transparent');
            
            // Show selected tab
            if (tabName === 'checkpoints') {
                document.getElementById('checkpointsTab').classList.remove('hidden');
                document.getElementById('tabCheckpoints').classList.add('border-white');
                document.getElementById('tabCheckpoints').classList.remove('border-transparent');
            } else if (tabName === 'worklogs') {
                document.getElementById('worklogsTab').classList.remove('hidden');
                document.getElementById('tabWorklogs').classList.add('border-white');
                document.getElementById('tabWorklogs').classList.remove('border-transparent');
                renderWorkLogs();
            } else if (tabName === 'artifacts') {
                document.getElementById('artifactsTab').classList.remove('hidden');
                document.getElementById('tabArtifacts').classList.add('border-white');
                document.getElementById('tabArtifacts').classList.remove('border-transparent');
                renderArtifacts();
            }
        }

        // ===================================
        // RENDERING
        // ===================================

        function renderCheckpoints() {
            const container = document.getElementById('checkpointsList');
            const emptyState = document.getElementById('emptyState');
            
            let allCheckpoints = [];

            // Gather all checkpoints from all projects
            currentData.projects.forEach(project => {
                project.checkpoints.forEach(checkpoint => {
                    allCheckpoints.push({
                        ...checkpoint,
                        projectId: project.id,
                        projectName: project.name
                    });
                });
            });

            if (allCheckpoints.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');

            // Apply filters
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const projectFilter = document.getElementById('projectFilter').value;
            const sortOrder = document.getElementById('sortOrder').value;

            let filtered = allCheckpoints.filter(cp => {
                const matchesSearch = !searchTerm || 
                    cp.content.toLowerCase().includes(searchTerm) ||
                    (cp.label && cp.label.toLowerCase().includes(searchTerm)) ||
                    cp.projectName.toLowerCase().includes(searchTerm);
                
                const matchesProject = !projectFilter || cp.projectId === projectFilter;

                return matchesSearch && matchesProject;
            });

            // Sort
            if (sortOrder === 'newest') {
                filtered.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            } else if (sortOrder === 'oldest') {
                filtered.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            } else if (sortOrder === 'project') {
                filtered.sort((a, b) => a.projectName.localeCompare(b.projectName));
            }

            // Render
            container.innerHTML = filtered.map(cp => {
                // Count work logs linked to this checkpoint
                const workLogCount = currentData.worklogs.filter(wl => wl.checkpointId === cp.id).length;
                
                return `
                <div class="checkpoint-card bg-white rounded-lg shadow-md p-6">
                    <div class="flex justify-between items-start mb-3" onclick="viewCheckpoint('${cp.projectId}', '${cp.id}')" style="cursor: pointer;">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">
                                ${escapeHtml(getCheckpointLabel(cp))}
                            </h3>
                            <p class="text-sm text-gray-500">
                                ${escapeHtml(cp.projectName)} ‚Ä¢ ${formatDate(cp.timestamp)}
                            </p>
                        </div>
                        <div class="flex items-center gap-2">
                            ${workLogCount > 0 ? `
                                <button onclick="event.stopPropagation(); filterWorkLogsByCheckpoint('${cp.id}')" 
                                        class="text-xs bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600 transition"
                                        title="View ${workLogCount} linked work log${workLogCount > 1 ? 's' : ''}">
                                    üìù ${workLogCount} log${workLogCount > 1 ? 's' : ''}
                                </button>
                            ` : ''}
                            
                            ${(() => {
                                const artifactCount = currentData.artifacts.filter(a => (a.linkedCheckpoints || []).includes(cp.id)).length;
                                return artifactCount > 0 ? `
                                    <button onclick="event.stopPropagation(); filterArtifactsByCheckpoint('${cp.id}')"
                                            class="text-xs bg-purple-500 text-white px-2 py-1 rounded hover:bg-purple-600 transition"
                                            title="View ${artifactCount} linked artifact${artifactCount > 1 ? 's' : ''}">
                                        üìé ${artifactCount} art${artifactCount > 1 ? 's' : ''}
                                    </button>
                                ` : '';
                            })()}
${cp.validation.isComplete 
                                ? '<span class="text-green-600 text-sm">‚úì Complete</span>' 
                                : '<span class="text-yellow-600 text-sm">‚ö† Incomplete</span>'}
                        </div>
                    </div>
                    <div class="text-sm text-gray-600 line-clamp-3 mb-3" onclick="viewCheckpoint('${cp.projectId}', '${cp.id}')" style="cursor: pointer;">
                        ${escapeHtml(cp.content.substring(0, 200))}...
                    </div>
                    <div class="flex justify-between pt-2 border-t border-gray-100">
                        <button onclick="event.stopPropagation(); editCheckpoint('${cp.projectId}', '${cp.id}')" 
                                class="text-sm px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition">
                            ‚úèÔ∏è Edit
                        </button>
                        <button onclick="event.stopPropagation(); copyRestorationPrompt('${cp.projectId}', '${cp.id}')" 
                                class="btn-restore-card">
                            üîÑ Restore prompt
                        </button>
                    </div>
                </div>
            `;
            }).join('');
        }

        function viewCheckpoint(projectId, checkpointId) {
            const project = getProject(projectId);
            if (!project) return;

            const checkpoint = project.checkpoints.find(cp => cp.id === checkpointId);
            if (!checkpoint) return;

            currentViewingCheckpoint = { projectId, checkpointId };

            document.getElementById('viewCheckpointTitle').textContent = 
                getCheckpointLabel(checkpoint);
            
            document.getElementById('viewCheckpointMeta').textContent = 
                `${project.name} ‚Ä¢ ${formatDate(checkpoint.timestamp)}`;

            document.getElementById('viewCheckpointContent').textContent = checkpoint.content;

            const modal = document.getElementById('viewCheckpointModal');
            modal.classList.remove('hidden');
            
            // Reset scroll position
            const modalContent = modal.querySelector('.overflow-y-auto');
            if (modalContent) modalContent.scrollTop = 0;

            // Update last used timestamp
            checkpoint.lastUsed = new Date().toISOString();
            saveData();
        }

        function filterCheckpoints() {
            renderCheckpoints();
        
            updateProjectContextIndicator();
}

        // ===================================
        // CLIPBOARD & EXPORT/IMPORT
        // ===================================

        function copyCheckpointToClipboard() {
            const content = document.getElementById('viewCheckpointContent').textContent;
            
            navigator.clipboard.writeText(content).then(() => {
                showNotification('Copied to clipboard! ‚úì', 'success');
            }).catch(err => {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = content;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showNotification('Copied to clipboard! ‚úì', 'success');
            });
        }

        // ===================================
        // EXPORT MODAL
        // ===================================

        function showExportModal() {
            const modal = document.getElementById('exportModal');
            
            // Update project checkboxes
            const projectCheckboxes = document.getElementById('projectCheckboxes');
            projectCheckboxes.innerHTML = currentData.projects.map(project => {
                const cpCount = project.checkpoints ? project.checkpoints.length : 0;
                const wlCount = currentData.worklogs.filter(wl => wl.projectId === project.id).length;
                const artCount = currentData.artifacts.filter(art => art.projectId === project.id).length;
                
                return `
                    <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                        <input type="checkbox" 
                               class="export-project-checkbox mr-2" 
                               value="${project.id}"
                               onchange="updateExportPreview()">
                        <div class="text-sm">
                            <div class="font-medium text-gray-900">${escapeHtml(project.name)}</div>
                            <div class="text-gray-600">${cpCount} checkpoints, ${wlCount} logs, ${artCount} artifacts</div>
                        </div>
                    </label>
                `;
            }).join('');
            
            modal.classList.remove('hidden');
            updateExportPreview();
        }

        function closeExportModal() {
            document.getElementById('exportModal').classList.add('hidden');
        }

        function updateExportPreview() {
            const exportOption = document.querySelector('input[name="exportOption"]:checked').value;
            const projectCheckboxesContainer = document.getElementById('projectCheckboxes');
            const preview = document.getElementById('exportPreview');
            
            // Show/hide project checkboxes
            if (exportOption === 'selective') {
                projectCheckboxesContainer.classList.remove('hidden');
            } else {
                projectCheckboxesContainer.classList.add('hidden');
            }
            
            // Update preview
            if (exportOption === 'all') {
                const totalCheckpoints = currentData.projects.reduce((sum, p) => sum + (p.checkpoints ? p.checkpoints.length : 0), 0);
                preview.innerHTML = `
                    ‚Ä¢ ${currentData.projects.length} project${currentData.projects.length !== 1 ? 's' : ''}<br>
                    ‚Ä¢ ${totalCheckpoints} checkpoint${totalCheckpoints !== 1 ? 's' : ''}<br>
                    ‚Ä¢ ${currentData.worklogs.length} work log${currentData.worklogs.length !== 1 ? 's' : ''}<br>
                    ‚Ä¢ ${currentData.artifacts.length} artifact${currentData.artifacts.length !== 1 ? 's' : ''}
                `;
            } else {
                const selectedCheckboxes = document.querySelectorAll('.export-project-checkbox:checked');
                const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value);
                
                if (selectedIds.length === 0) {
                    preview.innerHTML = '<span class="text-gray-500">No projects selected</span>';
                } else {
                    const selectedProjects = currentData.projects.filter(p => selectedIds.includes(p.id));
                    const totalCheckpoints = selectedProjects.reduce((sum, p) => sum + (p.checkpoints ? p.checkpoints.length : 0), 0);
                    const totalWorklogs = currentData.worklogs.filter(wl => selectedIds.includes(wl.projectId)).length;
                    const totalArtifacts = currentData.artifacts.filter(art => selectedIds.includes(art.projectId)).length;
                    
                    preview.innerHTML = `
                        ‚Ä¢ ${selectedProjects.length} project${selectedProjects.length !== 1 ? 's' : ''}<br>
                        ‚Ä¢ ${totalCheckpoints} checkpoint${totalCheckpoints !== 1 ? 's' : ''}<br>
                        ‚Ä¢ ${totalWorklogs} work log${totalWorklogs !== 1 ? 's' : ''}<br>
                        ‚Ä¢ ${totalArtifacts} artifact${totalArtifacts !== 1 ? 's' : ''}
                    `;
                }
            }
        }

        function performExport() {
            const exportOption = document.querySelector('input[name="exportOption"]:checked').value;
            let exportData;
            let filename;
            
            if (exportOption === 'all') {
                exportData = currentData;
                filename = `Vizier_Export_All_${new Date().toISOString().split('T')[0]}.json`;
            } else {
                const selectedCheckboxes = document.querySelectorAll('.export-project-checkbox:checked');
                const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value);
                
                if (selectedIds.length === 0) {
                    alert('Please select at least one project to export');
                    return;
                }
                
                // Create filtered export
                exportData = {
                    version: currentData.version,
                    projects: currentData.projects.filter(p => selectedIds.includes(p.id)),
                    worklogs: currentData.worklogs.filter(wl => selectedIds.includes(wl.projectId)),
                    artifacts: currentData.artifacts.filter(art => selectedIds.includes(art.projectId))
                };
                
                const projectNames = exportData.projects.map(p => p.name.replace(/\s+/g, '')).join('_');
                filename = `Vizier_Export_${projectNames}_${new Date().toISOString().split('T')[0]}.json`;
            }
            
            // Perform export
            const dataStr = JSON.stringify(exportData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
            
            closeExportModal();
            showNotification('Data exported successfully!', 'success');
        }

        // ===================================
        // CLEAR ALL DATA MODAL
        // ===================================

        function showClearAllDataModal() {
            const modal = document.getElementById('clearAllDataModal');
            
            // Update counts
            const totalCheckpoints = currentData.projects.reduce((sum, p) => sum + (p.checkpoints ? p.checkpoints.length : 0), 0);
            document.getElementById('clearDataProjectCount').textContent = `‚Ä¢ ${currentData.projects.length} project${currentData.projects.length !== 1 ? 's' : ''}`;
            document.getElementById('clearDataCheckpointCount').textContent = `‚Ä¢ ${totalCheckpoints} checkpoint${totalCheckpoints !== 1 ? 's' : ''}`;
            document.getElementById('clearDataWorklogCount').textContent = `‚Ä¢ ${currentData.worklogs.length} work log${currentData.worklogs.length !== 1 ? 's' : ''}`;
            document.getElementById('clearDataArtifactCount').textContent = `‚Ä¢ ${currentData.artifacts.length} artifact${currentData.artifacts.length !== 1 ? 's' : ''}`;
            
            // Reset confirmation input
            document.getElementById('clearDataConfirmation').value = '';
            document.getElementById('clearAllDataButton').disabled = true;
            
            modal.classList.remove('hidden');
        }

        function closeClearAllDataModal() {
            document.getElementById('clearAllDataModal').classList.add('hidden');
        }

        // Enable button when "DELETE" is typed
        document.addEventListener('DOMContentLoaded', function() {
            
            updateProjectContextIndicator();
const confirmInput = document.getElementById('clearDataConfirmation');
            if (confirmInput) {
                confirmInput.addEventListener('input', function() {
                    const button = document.getElementById('clearAllDataButton');
                    button.disabled = this.value !== 'DELETE';
                });
            }
        });

        
        // Modal consistency helpers: close buttons + ESC-to-close
        function closeModalById(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.classList.add('hidden');
        }

        function getOpenModals() {
            return Array.from(document.querySelectorAll('div[id$="Modal"].fixed'))
                .filter(m => !m.classList.contains('hidden'));
        }

        function closeTopmostModal() {
            const open = getOpenModals();
            if (open.length === 0) return false;
            closeModalById(open[open.length - 1].id);
            return true;
        }

        function ensureModalCloseButtons() {
            const modals = document.querySelectorAll('div[id$="Modal"].fixed');
            modals.forEach(modal => {
                const box = modal.querySelector('.bg-white');
                if (!box) return;

                // Make the modal box a positioning context for an absolute close button
                box.classList.add('relative');

                // Avoid duplicating if an X already exists
                if (box.querySelector('[data-modal-x-close="1"]')) return;

                // If the modal already includes an X button, do not add another
                const hasXButton = Array.from(box.querySelectorAll('button'))
                    .some(b => ((b.textContent || '').trim() === '‚úï'));
                if (hasXButton) return;

                const btn = document.createElement('button');
                btn.setAttribute('data-modal-x-close', '1');
                btn.setAttribute('type', 'button');
                btn.setAttribute('aria-label', 'Close');
                btn.className = 'absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-xl';
                btn.textContent = '‚úï';
                btn.addEventListener('click', () => closeModalById(modal.id));
                box.appendChild(btn);
            });
        }

        // ESC closes the topmost visible modal (including Projects)
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const closed = closeTopmostModal();
                if (closed) e.preventDefault();
            }
        });

        // Add X-close buttons to any modals that do not already have one
        document.addEventListener('DOMContentLoaded', function() {
            ensureModalCloseButtons();
        });

function performClearAllData() {
            const confirmation = document.getElementById('clearDataConfirmation').value;
            
            if (confirmation !== 'DELETE') {
                alert('Please type DELETE to confirm');
                return;
            }
            
            // Clear all data
            currentData = {
                version: currentData.version,
                projects: [],
                artifacts: [],
                worklogs: []
            };
            
            saveData();
            closeClearAllDataModal();
            updateProjectDropdowns();
            renderCheckpoints();
            renderWorkLogs();
            renderArtifacts();
            
            showNotification('All data cleared', 'info');
        }

        // ===================================
        // IMPORT
        // ===================================

        function importData() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];

            if (!file) {
                alert('Please select a file');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    
                    // Merge imported data with existing (avoid duplicate checkpoints)
                    imported.projects.forEach(importedProject => {
                        const existing = currentData.projects.find(p => p.id === importedProject.id);
                        if (existing) {
                            // Merge checkpoints by id
                            importedProject.checkpoints.forEach(cp => {
                                if (!existing.checkpoints.find(ecp => ecp.id === cp.id)) {
                                    existing.checkpoints.push(cp);
                                }
                            });
                        } else {
                            currentData.projects.push(importedProject);
                        }
                    });


                    // Merge imported work logs (if present)
                    if (imported.worklogs && Array.isArray(imported.worklogs)) {
                        if (!currentData.worklogs) currentData.worklogs = [];
                        imported.worklogs.forEach(wl => {
                            if (wl && wl.id && !currentData.worklogs.find(e => e.id === wl.id)) {
                                currentData.worklogs.push(wl);
                            }
                        });
                    }

                    // Merge imported artifacts (if present)
                    if (imported.artifacts && Array.isArray(imported.artifacts)) {
                        if (!currentData.artifacts) currentData.artifacts = [];
                        imported.artifacts.forEach(art => {
                            if (art && art.id && !currentData.artifacts.find(e => e.id === art.id)) {
                                currentData.artifacts.push(art);
                            }
                        });
                    }

                    // Rebuild / update Artifact Registry indexes based on all checkpoints
                    scanExistingCheckpointsForArtifacts();

                    saveData();
                    closeImportModal();
                    updateProjectDropdowns();
                    renderCheckpoints();
                    renderWorkLogs();
                    renderArtifacts();
                    showNotification('Data imported successfully!', 'success');
                } catch (err) {
                    alert('Error importing data: ' + err.message);
                }
            };
            reader.readAsText(file);
        }

        // ===================================
        // MODAL CONTROLS
        // ===================================

        function showSaveCheckpointModal() {
            const modal = document.getElementById('saveCheckpointModal');
            modal.classList.remove('hidden');
updateProjectDropdowns(document.getElementById('checkpointProject'));
            applyCurrentProjectToSelect('checkpointProject');
            
            // Reset scroll position
            const modalContent = modal.querySelector('.overflow-y-auto');
            if (modalContent) modalContent.scrollTop = 0;
            
            document.getElementById('checkpointContent').value = '';
            document.getElementById('checkpointLabel').value = '';
            document.getElementById('validationResults').classList.add('hidden');
            
            // Reset to create mode
            window.editingCheckpoint = null;
            document.querySelector('#saveCheckpointModal h2').textContent = 'Save Checkpoint';
            document.querySelector('#saveCheckpointModal button[onclick="saveCheckpoint()"]').textContent = 'Save Checkpoint';
        }

        function closeSaveCheckpointModal() {
            document.getElementById('saveCheckpointModal').classList.add('hidden');
            
            // Clear editing flag
            window.editingCheckpoint = null;
            
            // Reset modal title and button text
            document.querySelector('#saveCheckpointModal h2').textContent = 'Save Checkpoint';
            document.querySelector('#saveCheckpointModal button[onclick="saveCheckpoint()"]').textContent = 'Save Checkpoint';
        }

        function showNewProjectModal() {
            document.getElementById('newProjectModal').classList.remove('hidden');
            document.getElementById('newProjectName').value = '';
        }

        function closeNewProjectModal() {
            document.getElementById('newProjectModal').classList.add('hidden');
        }

        function showImportModal() {
            document.getElementById('importModal').classList.remove('hidden');
            document.getElementById('importFile').value = '';
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.add('hidden');
        }

        function closeViewCheckpointModal() {
            document.getElementById('viewCheckpointModal').classList.add('hidden');
            currentViewingCheckpoint = null;
        }

        // ===================================
        // UTILITY FUNCTIONS
        // ===================================

        function formatDate(isoString) {
            const date = new Date(isoString);
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

            if (diffDays === 0) {
                return 'Today ' + date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            } else if (diffDays === 1) {
                return 'Yesterday';
            } else if (diffDays < 7) {
                return `${diffDays} days ago`;
            } else {
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showNotification(message, type = 'info') {
            const colors = {
                success: 'bg-green-500',
                warning: 'bg-yellow-500',
                error: 'bg-red-500',
                info: 'bg-blue-500'
            };

            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-opacity`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // ===================================
        // INITIALIZATION
        // ===================================

        function scanExistingCheckpointsForArtifacts() {
            // Scan all existing checkpoints and extract artifacts
            let newArtifactsCount = 0;
            
            currentData.projects.forEach(project => {
                if (project.checkpoints && project.checkpoints.length > 0) {
                    project.checkpoints.forEach(checkpoint => {
                        const beforeCount = currentData.artifacts.length;
                        // Use new extraction method
                        const artifacts = extractArtifactsFromContent(checkpoint.content, project.id);
                        artifacts.forEach(artData => {
                            saveApprovedArtifact(artData, checkpoint.id);
                        });
                        const afterCount = currentData.artifacts.length;
                        newArtifactsCount += (afterCount - beforeCount);
                    });
                }
            });
            
            if (newArtifactsCount > 0) {
                saveData();
                console.log(`Scanned existing checkpoints: ${newArtifactsCount} new artifacts found`);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            initData();
            loadCurrentProjectId();
            scanExistingCheckpointsForArtifacts(); // Scan existing checkpoints
            updateProjectDropdowns();
            updateProjectContextIndicator();
            applyCurrentProjectToFilters();
            renderCheckpoints();
        });

        // Close modals on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closePromptGeneratorModal();
                closeSaveCheckpointModal();
                closeNewProjectModal();
                closeImportModal();
                closeExportModal();
                closeClearAllDataModal();
                closeViewCheckpointModal();
                closeAddArtifactModal();
                closeAboutModal();
                closeRestorationPromptModal();
                closeWorkLogGeneratorModal();
                closeSaveWorkLogModal();
                closeViewWorkLogModal();
            }
        });

        // ===================================
        // ABOUT MODAL
        // ===================================
        
        function showAboutModal() {
            const modal = document.getElementById('aboutModal');
            if (!modal) {
                console.error('About modal not found: #aboutModal');
                return;
            }
            modal.classList.remove('hidden');
        }
        
        function closeAboutModal() {
            const modal = document.getElementById('aboutModal');
            if (!modal) return;
            modal.classList.add('hidden');
        }

        // ===================================
        // RESTORATION PROMPT GENERATOR
        // ===================================
        
        function generateRestorationPrompt(projectId, checkpointId) {
            const project = getProject(projectId);
            if (!project) return;
            
            const checkpoint = project.checkpoints.find(cp => cp.id === checkpointId);
            if (!checkpoint) return;
            
            const restorationPrompt = `Restore this project using the summary below, which is the latest checkpoint.
Treat the checkpoint as the authoritative record for this project.
Do not invent missing context or change prior decisions unless I explicitly say so.

After reading it:
1) Briefly restate the current project state and plan.
2) List any files or artifacts you need me to re-upload.
3) Wait for my confirmation before doing new work.

---
${checkpoint.content}
---`;
            
            // Show in modal
            document.getElementById('restorationPromptTitle').textContent = getCheckpointLabel(checkpoint);
            document.getElementById('restorationPromptMeta').textContent = `${project.name} ‚Ä¢ ${formatDate(checkpoint.timestamp)}`;
            document.getElementById('restorationPromptText').textContent = restorationPrompt;
            document.getElementById('restorationPromptModal').classList.remove('hidden');
            
            // Store for copying
            window.currentRestorationPrompt = restorationPrompt;
        }

        // Quick action: copy restoration prompt directly (used by checkpoint card Restore button)
        function copyRestorationPrompt(projectId, checkpointId) {
            const project = getProject(projectId);
            if (!project) return;

            const checkpoint = project.checkpoints.find(cp => cp.id === checkpointId);
            if (!checkpoint) return;

            const restorationPrompt = `Restore this project using the summary below, which is the latest checkpoint.
Treat the checkpoint as the authoritative record for this project.
Do not invent missing context or change prior decisions unless I explicitly say so.

After reading it:
1) Briefly restate the current project state and plan.
2) List any files or artifacts you need me to re-upload.
3) Wait for my confirmation before doing new work.

---
${checkpoint.content}
---`;

            navigator.clipboard.writeText(restorationPrompt).then(() => {
                showNotification('Restore prompt copied to clipboard.', 'success');
            }).catch(err => {
                const textarea = document.createElement('textarea');
                textarea.value = restorationPrompt;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showNotification('Restore prompt copied to clipboard.', 'success');
            });
        }

        // Quick action: download checkpoint as .txt from view modal
        function downloadCurrentCheckpointTxt() {
            if (!currentViewingCheckpoint) return;
            downloadCheckpointTxt(currentViewingCheckpoint.projectId, currentViewingCheckpoint.checkpointId);
        }

        function sanitizeFilename(name) {
            return (name || 'checkpoint')
                .replace(/\s+/g, '_')
                .replace(/[^a-zA-Z0-9_\-\.]/g, '')
                .substring(0, 80) || 'checkpoint';
        }

        function downloadCheckpointTxt(projectId, checkpointId) {
            const project = getProject(projectId);
            if (!project) return;

            const checkpoint = project.checkpoints.find(cp => cp.id === checkpointId);
            if (!checkpoint) return;

            const label = getCheckpointLabel(checkpoint);
            const ts = checkpoint.timestamp ? new Date(checkpoint.timestamp) : new Date();
            const tsStr = ts.toISOString().replace(/[:]/g, '-').replace(/\..*$/, '');
            const filename = `${sanitizeFilename(project.name)}__${sanitizeFilename(label)}__${tsStr}.txt`;

            const body = [
                `CHECKPOINT: ${label}`,
                `Project: ${project.name}`,
                `Date: ${formatDate(checkpoint.timestamp)}`,
                '',
                checkpoint.content || ''
            ].join('\n');

            const blob = new Blob([body], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            setTimeout(() => URL.revokeObjectURL(url), 0);
            showNotification('Checkpoint downloaded.', 'success');
        }

        
        function closeRestorationPromptModal() {
            document.getElementById('restorationPromptModal').classList.add('hidden');
        }
        
        function copyRestorationPrompt() {
            const prompt = window.currentRestorationPrompt;
            if (!prompt) return;
            
            navigator.clipboard.writeText(prompt).then(() => {
                showNotification('Restoration prompt copied! Paste into new AI session.', 'success');
            }).catch(err => {
                // Fallback
                const textarea = document.createElement('textarea');
                textarea.value = prompt;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showNotification('Restoration prompt copied! Paste into new AI session.', 'success');
            });
        }
        
        // Generate restoration prompt from inside View Checkpoint modal
        function generateRestorationPromptFromModal() {
            if (!currentViewingCheckpoint) return;
            generateRestorationPrompt(
                currentViewingCheckpoint.projectId,
                currentViewingCheckpoint.checkpointId
            );
        }

</script>

</body>
                </html>
